version: 2

models:
  - name: campaign_clusters
    description: |
      Identifies high-performing marketing campaign combinations based on Goal, Segment, Channel, and Duration.
      This model groups campaigns, calculates performance metrics (ROI, Conversion Rate, Acquisition Cost, CTR) for each combination,
      ranks them within each company, compares them to company and global averages, determines optimal duration ranges,
      and flags the top combinations as 'winning'. It simulates a clustering analysis using SQL aggregations and rankings.
      Only combinations with at least 3 campaigns are considered for statistical significance.
    config:
      materialized: table
      tags: ['mart', 'marketing', 'analysis', 'optimization']
    columns:
      - name: Company
        description: "The company associated with the campaign combination."
        tests:
          - not_null
          # Part of the unique combination key
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - goal
                - segment
                - channel
                - duration_bucket
      - name: goal
        description: "The primary goal of the campaigns in this combination (e.g., Increase Sales, Brand Awareness)."
        tests:
          - not_null
      - name: segment
        description: "The target customer segment for the campaigns in this combination (e.g., Fashion, Tech Enthusiasts)."
        tests:
          - not_null
      - name: channel
        description: "The marketing channel used for the campaigns in this combination (e.g., Facebook, Google Ads, Email)."
        tests:
          - not_null
      - name: duration_bucket
        description: "The calculated duration range category for the campaigns in this combination (e.g., '1-7 days', '8-14 days')."
        tests:
          - not_null
          - accepted_values:
              values: ['1-7 days', '8-14 days', '15-21 days', '22-30 days', '31-45 days', '46-60 days', '60+ days']
      - name: avg_conversion_rate
        description: "The average conversion rate achieved by campaigns within this specific combination."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              # Max value can theoretically exceed 1 if conversion is defined differently, but typically <= 1
              # max_value: 1 # Optional: Add if strictly a rate between 0 and 1
      - name: avg_roi
        description: "The average Return on Investment (ROI) for campaigns within this specific combination."
        tests:
          - not_null
          # ROI can be negative, so no min_value: 0 test
      - name: avg_acquisition_cost
        description: "The average cost to acquire a customer (Acquisition Cost) for campaigns within this specific combination."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      - name: avg_ctr
        description: "The average Click-Through Rate (CTR) for campaigns within this specific combination (Clicks / Impressions)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              # max_value: 1 # Optional: Add if strictly a rate between 0 and 1
      - name: campaign_count
        description: "The number of individual campaigns grouped into this specific combination. Used to ensure statistical significance (minimum 3)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 3 # Based on the HAVING clause in the model logic
      - name: min_duration
        description: "The minimum duration (in days) among campaigns within this combination."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1 # Assuming duration is at least 1 day
      - name: max_duration
        description: "The maximum duration (in days) among campaigns within this combination."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: avg_duration
        description: "The average duration (in days) of campaigns within this combination."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: conversion_rate_vs_company
        description: "Ratio comparing this combination's average conversion rate to the company's overall average conversion rate across all combinations."
        tests:
          - not_null # Handled by NULLIF in division
      - name: roi_vs_company
        description: "Ratio comparing this combination's average ROI to the company's overall average ROI across all combinations."
        tests:
          - not_null # Handled by NULLIF in division
      - name: acquisition_cost_vs_company
        description: "Ratio comparing the company's overall average acquisition cost to this combination's average acquisition cost (inverted for intuitive comparison - higher is better)."
        tests:
          - not_null # Handled by NULLIF in division
      - name: ctr_vs_company
        description: "Ratio comparing this combination's average CTR to the company's overall average CTR across all combinations."
        tests:
          - not_null # Handled by NULLIF in division
      - name: conversion_rate_vs_global
        description: "Ratio comparing this combination's average conversion rate to the global average conversion rate across all companies and combinations."
        tests:
          - not_null # Handled by NULLIF in division
      - name: roi_vs_global
        description: "Ratio comparing this combination's average ROI to the global average ROI across all companies and combinations."
        tests:
          - not_null # Handled by NULLIF in division
      - name: acquisition_cost_vs_global
        description: "Ratio comparing the global average acquisition cost to this combination's average acquisition cost (inverted for intuitive comparison - higher is better)."
        tests:
          - not_null # Handled by NULLIF in division
      - name: ctr_vs_global
        description: "Ratio comparing this combination's average CTR to the global average CTR across all companies and combinations."
        tests:
          - not_null # Handled by NULLIF in division
      - name: conversion_rate_rank
        description: "The rank of this combination within its company based on average conversion rate (1 = highest)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: roi_rank
        description: "The rank of this combination within its company based on average ROI (1 = highest)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: acquisition_cost_rank
        description: "The rank of this combination within its company based on average acquisition cost (1 = lowest)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: ctr_rank
        description: "The rank of this combination within its company based on average CTR (1 = highest)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: composite_rank
        description: "The overall rank of this combination within its company based on a weighted composite score of individual metric ranks (1 = best overall)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: composite_score
        description: "A weighted score calculated from individual metric ranks (ROI, Conversion Rate, Acquisition Cost, CTR). Lower score indicates better overall performance."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0 # Score is based on ranks >= 1, weighted positively, so >= 0
      - name: optimal_duration_bucket
        description: "The duration bucket identified as having the highest average ROI for this specific Company-Goal-Segment-Channel combination (regardless of the current row's duration bucket)."
        tests:
          - not_null
          - accepted_values:
              values: ['1-7 days', '8-14 days', '15-21 days', '22-30 days', '31-45 days', '46-60 days', '60+ days']
      - name: optimal_min_duration
        description: "The minimum campaign duration observed within the optimal duration bucket for this Company-Goal-Segment-Channel combination."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: optimal_max_duration
        description: "The maximum campaign duration observed within the optimal duration bucket for this Company-Goal-Segment-Channel combination."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: is_winning_combination
        description: "Boolean flag indicating if this combination ranks within the top 10% based on the composite score for its company (TRUE = Winning)."
        tests:
          - not_null
      - name: is_optimal_duration
        description: "Boolean flag indicating if this specific combination's duration bucket matches the identified optimal duration bucket for its Company-Goal-Segment-Channel (TRUE = Uses Optimal Duration)."
        tests:
          - not_null
      - name: optimal_duration_range
        description: "A formatted string representing the optimal duration range (e.g., '15-21 days') based on the min/max durations found in the optimal bucket."
        tests:
          - not_null