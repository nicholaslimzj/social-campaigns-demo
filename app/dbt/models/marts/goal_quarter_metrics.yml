version: 2

models:
  - name: goal_quarter_metrics
    description: |
      Aggregates campaign performance metrics by company and campaign goal for the current quarter (latest 3 months of data).
      This model provides a strategic view of performance, focusing on Company as the primary dimension and Campaign_Goal as the secondary.
      It calculates key metrics, quarter-over-quarter changes, ranks goals within companies, normalizes performance using z-scores,
      and assigns a composite performance score and tier. Designed for dashboard usage like Campaign Goals Analysis and ROI Analysis.
    config:
      materialized: table
      tags:
        - 'mart'
        - 'marketing'
        - 'performance'
        - 'quarterly'
        - 'analytics'
    columns:
      - name: Company
        description: "Identifier for the company associated with the campaign metrics. Primary dimension."
        tests:
          - not_null
          # Test relationship back to the staging source
          - relationships:
              to: ref('stg_campaigns')
              field: Company
          # Test for uniqueness across the combination of Company and goal for the quarter
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - goal

      - name: goal
        description: "The specific goal of the campaigns being aggregated (e.g., Brand Awareness, Increase Sales). Secondary dimension. Aliased from Campaign_Goal."
        tests:
          - not_null
          # Test relationship back to the staging source using the original column name
          - relationships:
              to: ref('stg_campaigns')
              field: Campaign_Goal
          # Optional: Add accepted values if the list of goals is known and fixed
          # - accepted_values:
          #     values: ['Brand Awareness', 'Increase Sales', 'Market Expansion', 'Product Launch', ...]

      - name: campaign_count
        description: "The total number of campaigns contributing to this company-goal combination in the current quarter."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0 # A group could theoretically have 0 campaigns if filtered weirdly, but likely >= 1

      - name: avg_conversion_rate
        description: "Average conversion rate for campaigns under this company and goal in the current quarter."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0 # Conversion rate cannot be negative

      - name: avg_roi
        description: "Average Return on Investment (ROI) for campaigns under this company and goal in the current quarter."
        tests:
          - not_null # ROI can be negative

      - name: avg_acquisition_cost
        description: "Average cost to acquire a customer/conversion for campaigns under this company and goal in the current quarter."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0 # Acquisition cost cannot be negative

      - name: ctr
        description: "Click-Through Rate (Total Clicks / Total Impressions) for campaigns under this company and goal in the current quarter. Can be NULL if total impressions are zero."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1 # CTR is typically between 0 and 1

      - name: total_clicks
        description: "Sum of all clicks for campaigns under this company and goal in the current quarter."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: total_impressions
        description: "Sum of all impressions for campaigns under this company and goal in the current quarter."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: total_spend
        description: "Calculated total spend (SUM(Clicks * Acquisition_Cost)) for campaigns under this company and goal in the current quarter."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0 # Spend cannot be negative

      - name: total_revenue
        description: "Calculated total revenue (SUM(Clicks * Acquisition_Cost * ROI)) for campaigns under this company and goal in the current quarter."
        tests:
          - not_null # Revenue can be negative if ROI is negative

      - name: roi_vs_prev_quarter
        description: "Percentage change in average ROI compared to the previous quarter. NULL if previous quarter data is unavailable or previous ROI was zero."

      - name: conversion_rate_vs_prev_quarter
        description: "Percentage change in average conversion rate compared to the previous quarter. NULL if previous quarter data is unavailable or previous rate was zero."

      - name: acquisition_cost_vs_prev_quarter
        description: "Percentage change in average acquisition cost compared to the previous quarter (positive value indicates improvement/lower cost). NULL if previous quarter data is unavailable or previous cost was zero."

      - name: ctr_vs_prev_quarter
        description: "Percentage change in CTR compared to the previous quarter. NULL if previous quarter data is unavailable or previous CTR was zero."

      - name: roi_rank
        description: "Rank of the campaign goal within the company based on average ROI (descending) for the current quarter. 1 is best."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: conversion_rate_rank
        description: "Rank of the campaign goal within the company based on average conversion rate (descending) for the current quarter. 1 is best."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: conversion_rate_z_score
        description: "Normalized score (z-score) indicating how many standard deviations the goal's average conversion rate is from the company's average conversion rate across all goals. 0 if standard deviation is zero."
        tests:
          - not_null

      - name: roi_z_score
        description: "Normalized score (z-score) indicating how many standard deviations the goal's average ROI is from the company's average ROI across all goals. 0 if standard deviation is zero."
        tests:
          - not_null

      - name: ctr_z_score
        description: "Normalized score (z-score) indicating how many standard deviations the goal's CTR is from the company's average CTR across all goals. 0 if standard deviation is zero."
        tests:
          - not_null

      - name: cost_efficiency_z_score
        description: "Normalized score (z-score) indicating cost efficiency. Calculated as the negative z-score of average acquisition cost (higher score means lower cost relative to the company average). 0 if standard deviation is zero."
        tests:
          - not_null

      - name: composite_performance_score
        description: "Weighted average of the z-scores for conversion rate (35%), ROI (35%), CTR (15%), and cost efficiency (15%), providing an overall performance indicator relative to the company average."
        tests:
          - not_null

      - name: performance_tier
        description: "Categorical tier ('Exceptional', 'High Performing', 'Average', 'Underperforming', 'Poor') assigned based on the composite performance score."
        tests:
          - not_null
          - accepted_values:
              values: ['Exceptional', 'High Performing', 'Average', 'Underperforming', 'Poor']