version: 2

models:
  - name: goal_quarter_metrics
    description: |
      Aggregates campaign performance metrics by company and campaign goal for the current quarter.
      This model provides a strategic quarterly view, focusing on Company as the primary dimension and Campaign_Goal as the secondary.
      It calculates key performance indicators (KPIs), quarter-over-quarter changes, ranks goals within companies, normalizes metrics using z-scores,
      computes a composite performance score, and assigns a performance tier based on the score.
      Designed for use in dashboards analyzing campaign goal performance, comparisons, and ROI.
      Time Context: Current Quarter (based on the latest 3 months of data in stg_campaigns).
    config:
      materialized: table
      tags:
        - 'mart'
        - 'marketing'
        - 'performance'
        - 'quarterly'
        - 'analytics'
    columns:
      - name: Company
        description: "Name of the company associated with the campaign metrics."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Company
          # Apply the multi-column unique constraint here
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - goal

      - name: goal
        description: "The specific goal of the campaigns being aggregated (e.g., Brand Awareness, Increase Sales)."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Campaign_Goal

      - name: campaign_count
        description: "Number of campaigns contributing to these metrics for the company and goal in the current quarter."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: avg_conversion_rate
        description: "Average conversion rate across campaigns for this company and goal in the current quarter."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0 # Conversion rate should be non-negative

      - name: avg_roi
        description: "Average Return on Investment (ROI) across campaigns for this company and goal in the current quarter."
        tests:
          - not_null

      - name: avg_acquisition_cost
        description: "Average acquisition cost across campaigns for this company and goal in the current quarter."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0 # Acquisition cost should be non-negative

      - name: ctr
        description: "Overall Click-Through Rate (Total Clicks / Total Impressions) for this company and goal in the current quarter. Can be NULL if total impressions are zero."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1 # CTR is typically between 0 and 1

      - name: total_clicks
        description: "Sum of all clicks for campaigns associated with this company and goal in the current quarter."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: total_impressions
        description: "Sum of all impressions for campaigns associated with this company and goal in the current quarter."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: total_spend
        description: "Calculated total spend based on clicks, conversion rate, and acquisition cost for this company and goal in the current quarter."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0 # Spend should generally be non-negative

      - name: total_revenue
        description: "Calculated total revenue based on spend and ROI for this company and goal in the current quarter."
        tests:
          - not_null # Revenue can be negative if ROI is significantly negative

      - name: roi_vs_prev_quarter
        description: "Percentage change in average ROI compared to the previous quarter. NULL if previous quarter data is unavailable or previous ROI was zero."

      - name: conversion_rate_vs_prev_quarter
        description: "Percentage change in average conversion rate compared to the previous quarter. NULL if previous quarter data is unavailable or previous rate was zero."

      - name: acquisition_cost_vs_prev_quarter
        description: "Percentage change in average acquisition cost compared to the previous quarter (positive value indicates improvement/lower cost). NULL if previous quarter data is unavailable or previous cost was zero."

      - name: ctr_vs_prev_quarter
        description: "Percentage change in CTR compared to the previous quarter. NULL if previous quarter data is unavailable or previous CTR was zero."

      - name: roi_rank
        description: "Rank of this goal's average ROI compared to other goals within the same company for the current quarter (1 = highest ROI)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1 # Rank starts from 1

      - name: conversion_rate_rank
        description: "Rank of this goal's average conversion rate compared to other goals within the same company for the current quarter (1 = highest rate)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1 # Rank starts from 1

      - name: conversion_rate_z_score
        description: "Normalized score (z-score) representing how many standard deviations the goal's average conversion rate is from the company's average conversion rate across all goals."

      - name: roi_z_score
        description: "Normalized score (z-score) representing how many standard deviations the goal's average ROI is from the company's average ROI across all goals."

      - name: ctr_z_score
        description: "Normalized score (z-score) representing how many standard deviations the goal's CTR is from the company's average CTR across all goals."

      - name: cost_efficiency_z_score
        description: "Normalized score (z-score) representing cost efficiency (based on inverted acquisition cost) relative to the company average. Higher is better (lower cost)."

      - name: composite_performance_score
        description: "A weighted average of the z-scores for key metrics (Conversion Rate: 35%, ROI: 35%, CTR: 15%, Cost Efficiency: 15%) indicating overall goal performance relative to the company average."

      - name: performance_tier
        description: "Categorical tier ('Exceptional', 'High Performing', 'Average', 'Underperforming', 'Poor') based on the composite performance score."
        tests:
          - not_null
          - accepted_values:
              values: ['Exceptional', 'High Performing', 'Average', 'Underperforming', 'Poor']