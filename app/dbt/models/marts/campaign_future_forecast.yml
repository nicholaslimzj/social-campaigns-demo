version: 2

models:
  - name: campaign_future_forecast
    description: |
      Mart model that generates campaign performance forecasts for the next 3 months.
      It utilizes historical monthly data from `stg_campaigns` to calculate trends,
      seasonal factors (if applicable), and projects key metrics like Conversion Rate,
      ROI, Acquisition Cost, and CTR using SQL-based time series techniques.
      The model also provides 95% confidence intervals for the forecasts based on
      historical volatility and includes both historical actuals and future projections.
      Designed for use in performance forecasting dashboards and predictive analytics.
    config:
      materialized: table
      tags:
        - 'mart'
        - 'campaigns'
        - 'forecast'
        - 'predictive'
        - 'monthly'
        - 'performance'
    columns:
      - name: Company
        description: "The name of the company associated with the campaign data. Foreign key to stg_campaigns.Company."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Company # Assuming 'Company' is the corresponding column in stg_campaigns

      - name: month_id
        description: "Numeric representation of the year and month (YYYYMM), used for time series ordering. Unique identifier for a company-month combination."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_positive

      - name: month
        description: "The calendar month number (1-12)."
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

      - name: year
        description: "The calendar year (e.g., 2022)."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 2000 # Adjust min_value based on expected data range
              max_value: 2050 # Adjust max_value based on expected data range

      - name: conversion_rate
        description: "Historical average conversion rate for the company in that specific month. Null for forecast periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative:
              config:
                severity: warn # Allow potential negative values but warn

      - name: conversion_rate_forecast
        description: "Projected average conversion rate for the company in a future month. Null for historical periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative:
              config:
                severity: warn # Allow potential negative values but warn

      - name: conversion_rate_lower_bound
        description: "Lower bound of the 95% confidence interval for the conversion rate forecast. Null for historical periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: conversion_rate_upper_bound
        description: "Upper bound of the 95% confidence interval for the conversion rate forecast. Null for historical periods."

      - name: roi
        description: "Historical average Return on Investment (ROI) for the company in that specific month. Null for forecast periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative:
              config:
                severity: warn # ROI can technically be negative

      - name: roi_forecast
        description: "Projected average ROI for the company in a future month. Null for historical periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative:
              config:
                severity: warn # ROI can technically be negative

      - name: roi_lower_bound
        description: "Lower bound of the 95% confidence interval for the ROI forecast. Null for historical periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative:
              config:
                severity: warn # ROI can technically be negative

      - name: roi_upper_bound
        description: "Upper bound of the 95% confidence interval for the ROI forecast. Null for historical periods."

      - name: acquisition_cost
        description: "Historical average acquisition cost for the company in that specific month. Null for forecast periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: acquisition_cost_forecast
        description: "Projected average acquisition cost for the company in a future month. Null for historical periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: acquisition_cost_lower_bound
        description: "Lower bound of the 95% confidence interval for the acquisition cost forecast (lower cost is better). Null for historical periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: acquisition_cost_upper_bound
        description: "Upper bound of the 95% confidence interval for the acquisition cost forecast. Null for historical periods."

      - name: ctr
        description: "Historical average Click-Through Rate (CTR) for the company in that specific month (Clicks / Impressions). Null for forecast periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: ctr_forecast
        description: "Projected average CTR for the company in a future month. Null for historical periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: ctr_lower_bound
        description: "Lower bound of the 95% confidence interval for the CTR forecast. Null for historical periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: ctr_upper_bound
        description: "Upper bound of the 95% confidence interval for the CTR forecast. Null for historical periods."

      - name: is_forecast
        description: "Boolean flag indicating whether the row represents forecasted data (TRUE) or historical actual data (FALSE)."
        tests:
          - not_null
          - accepted_values:
              values: [true, false]

      - name: month_name
        description: "The full name of the calendar month (e.g., 'January')."
        tests:
          - not_null
          - accepted_values:
              values: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']

      - name: conversion_rate_uncertainty
        description: "A measure of the relative uncertainty in the conversion rate forecast, calculated as the width of the confidence interval relative to the forecast value. Null for historical periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: roi_uncertainty
        description: "A measure of the relative uncertainty in the ROI forecast, calculated as the width of the confidence interval relative to the forecast value. Null for historical periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

    # Test for the composite primary key (Company + month_id)
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - Company
            - month_id