version: 2

models:
  - name: campaign_quarter_clusters
    description: |
      Identifies high-performing campaign combinations (Goal, Segment, Channel, Duration) for the current quarter (last 3 months).
      It calculates average performance metrics for each combination, ranks them based on a composite score (weighted towards ROI and Conversion Rate),
      determines the optimal duration range for each Goal-Segment-Channel group, and flags the top 10% performing combinations per company as 'winning combinations'.
      This model supports dashboard sections related to winning campaign strategies and optimization recommendations.
      It uses SQL-based aggregation and ranking to simulate clustering analysis.
    config:
      materialized: table
      tags: ['mart']
    columns:
      - name: Company
        description: "The company associated with the campaign combination."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Company # Assuming 'Company' exists in stg_campaigns

      - name: goal
        description: "The primary objective of the campaigns in this combination (e.g., 'Increase Sales', 'Brand Awareness'). Derived from stg_campaigns.Campaign_Goal."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Campaign_Goal # Assuming 'Campaign_Goal' exists in stg_campaigns

      - name: segment
        description: "The target customer segment for the campaigns in this combination (e.g., 'Fashion', 'Electronics'). Derived from stg_campaigns.Customer_Segment."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Customer_Segment # Assuming 'Customer_Segment' exists in stg_campaigns

      - name: channel
        description: "The marketing channel used for the campaigns in this combination (e.g., 'Facebook', 'Instagram'). Derived from stg_campaigns.Channel_Used."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Channel_Used # Assuming 'Channel_Used' exists in stg_campaigns

      - name: duration_bucket
        description: "The duration range category for the campaigns in this combination (e.g., '1-7 days', '15-21 days')."
        tests:
          - not_null
          - accepted_values:
              values: ['1-7 days', '8-14 days', '15-21 days', '22-30 days', '31-45 days', '46-60 days', '60+ days']
          # Test for unique combination of key dimensions
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - goal
                - segment
                - channel
                - duration_bucket

      - name: avg_conversion_rate
        description: "The average conversion rate achieved by campaigns within this specific combination for the quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1 # Conversion rate should be between 0 and 1

      - name: avg_roi
        description: "The average Return on Investment (ROI) generated by campaigns within this specific combination for the quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0 # Assuming ROI is generally expected to be non-negative in this context, adjust if negative ROI is common/valid

      - name: avg_acquisition_cost
        description: "The average cost to acquire a customer through campaigns within this specific combination for the quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0

      - name: avg_ctr
        description: "The average Click-Through Rate (Clicks / Impressions) for campaigns within this specific combination for the quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1 # CTR should be between 0 and 1

      - name: campaign_count
        description: "The number of individual campaigns included in this combination for the quarter. Only combinations with >= 3 campaigns are included."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 3 # Based on the HAVING clause in the SQL

      - name: min_duration
        description: "The minimum duration (in days) among campaigns within this combination."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: max_duration
        description: "The maximum duration (in days) among campaigns within this combination."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: avg_duration
        description: "The average duration (in days) of campaigns within this combination."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: conversion_rate_vs_company
        description: "Ratio of this combination's average conversion rate compared to the company's overall average conversion rate for the quarter. > 1 indicates better than company average."

      - name: roi_vs_company
        description: "Ratio of this combination's average ROI compared to the company's overall average ROI for the quarter. > 1 indicates better than company average."

      - name: acquisition_cost_vs_company
        description: "Ratio of the company's overall average acquisition cost compared to this combination's average acquisition cost for the quarter. > 1 indicates lower (better) cost than company average."

      - name: ctr_vs_company
        description: "Ratio of this combination's average CTR compared to the company's overall average CTR for the quarter. > 1 indicates better than company average."

      - name: conversion_rate_vs_global
        description: "Ratio of this combination's average conversion rate compared to the global average conversion rate across all companies for the quarter. > 1 indicates better than global average."

      - name: roi_vs_global
        description: "Ratio of this combination's average ROI compared to the global average ROI across all companies for the quarter. > 1 indicates better than global average."

      - name: acquisition_cost_vs_global
        description: "Ratio of the global average acquisition cost compared to this combination's average acquisition cost for the quarter. > 1 indicates lower (better) cost than global average."

      - name: ctr_vs_global
        description: "Ratio of this combination's average CTR compared to the global average CTR across all companies for the quarter. > 1 indicates better than global average."

      - name: conversion_rate_rank
        description: "Rank of this combination within the company based on average conversion rate (descending). 1 is best."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: roi_rank
        description: "Rank of this combination within the company based on average ROI (descending). 1 is best."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: acquisition_cost_rank
        description: "Rank of this combination within the company based on average acquisition cost (ascending). 1 is best (lowest cost)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: ctr_rank
        description: "Rank of this combination within the company based on average CTR (descending). 1 is best."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: composite_rank
        description: "Overall rank of this combination within the company based on the weighted composite score (ascending). 1 is the best overall combination."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: composite_score
        description: "A weighted score calculated from individual metric ranks (ROI: 40%, Conversion Rate: 30%, Acquisition Cost: 20%, CTR: 10%). Lower score is better."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0 # Score is based on ranks * weights, should be non-negative

      - name: optimal_duration_bucket
        description: "The duration bucket identified as having the highest average ROI for this specific Company, Goal, Segment, and Channel combination."
        tests:
          - not_null
          - accepted_values:
              values: ['1-7 days', '8-14 days', '15-21 days', '22-30 days', '31-45 days', '46-60 days', '60+ days']

      - name: optimal_min_duration
        description: "The minimum duration (in days) associated with the optimal duration bucket for this Company, Goal, Segment, and Channel."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: optimal_max_duration
        description: "The maximum duration (in days) associated with the optimal duration bucket for this Company, Goal, Segment, and Channel."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: is_winning_combination
        description: "Boolean flag indicating if this combination ranks within the top 10% based on the composite score for its company."
        tests:
          - not_null

      - name: is_optimal_duration
        description: "Boolean flag indicating if this combination's duration bucket matches the identified optimal duration bucket for its Company, Goal, Segment, and Channel."
        tests:
          - not_null

      - name: optimal_duration_range
        description: "A formatted string representing the optimal duration range (e.g., '15-21 days') based on the highest ROI for the Company, Goal, Segment, and Channel."
        tests:
          - not_null