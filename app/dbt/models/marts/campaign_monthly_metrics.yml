version: 2

models:
  - name: campaign_monthly_metrics
    description: >
      Aggregates key campaign performance metrics (clicks, impressions, spend, revenue, ROI, conversion rate, CTR)
      by company and month. Calculates month-over-month percentage changes for key metrics to facilitate
      company-specific time-based performance analysis, seasonal trend identification, and dashboard reporting.
      Serves as a foundation for company-specific time series visualizations and performance tracking.
    config:
      materialized: table
      tags: ['mart', 'monthly', 'performance', 'company']
    columns:
      - name: Company
        description: "Identifier for the company associated with the campaign metrics."
        tests:
          - not_null
          # Assuming 'stg_campaigns' has a unique list of companies or a dedicated dim_companies model exists
          # If stg_campaigns contains duplicates, this test might need adjustment or point to a dimension table.
          - relationships:
              to: ref('stg_campaigns')
              field: Company
          # Primary key constraint with month
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - month

      - name: month
        description: "The calendar month (1-12) for which the metrics are aggregated."
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

      - name: campaign_count
        description: "The total number of campaigns run by the company during the month."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: avg_conversion_rate
        description: "The average conversion rate across all campaigns for the company in the month."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              # Max value could be 1, but allowing flexibility
              # max_value: 1

      - name: avg_roi
        description: "The average Return on Investment (ROI) across all campaigns for the company in the month."
        tests:
          - not_null
          # ROI can theoretically be negative if costs exceed revenue significantly. No min/max applied.

      - name: avg_acquisition_cost
        description: "The average cost to acquire a customer/conversion across all campaigns for the company in the month."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: avg_ctr
        description: "The overall Click-Through Rate (CTR) across all campaigns for the company in the month (Total Clicks / Total Impressions)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              # Max value could be 1, but allowing flexibility
              # max_value: 1

      - name: total_clicks
        description: "The total number of clicks generated by the company's campaigns during the month."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: total_impressions
        description: "The total number of impressions served by the company's campaigns during the month."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: total_spend
        description: "The total amount spent on campaigns by the company during the month. Calculated as the sum of Acquisition_Cost from stg_campaigns."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: total_revenue
        description: "The total estimated revenue generated from campaigns by the company during the month. Calculated as total_spend * avg_roi."
        tests:
          - not_null
          # Revenue can be negative if ROI is negative.

      - name: roi_vs_prev_month
        description: "The percentage change in average ROI compared to the previous month for the company. Null for the first month of data or if previous month ROI was zero."

      - name: conversion_rate_vs_prev_month
        description: "The percentage change in average conversion rate compared to the previous month for the company. Null for the first month of data or if previous month conversion rate was zero."

      - name: acquisition_cost_vs_prev_month
        description: "The percentage change in average acquisition cost compared to the previous month for the company (positive value indicates improvement/lower cost). Null for the first month of data or if previous month acquisition cost was zero."

      - name: ctr_vs_prev_month
        description: "The percentage change in average CTR compared to the previous month for the company. Null for the first month of data or if previous month CTR was zero."