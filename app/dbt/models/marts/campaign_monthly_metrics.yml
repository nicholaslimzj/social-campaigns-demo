version: 2

models:
  - name: campaign_monthly_metrics
    description: |
      Aggregates campaign performance metrics by company and month.
      This model provides a time-based view of campaign effectiveness for each company,
      calculating key metrics, total spend/revenue, and month-over-month percentage changes.
      It facilitates company-specific performance tracking, seasonal analysis, and trend visualization.
    config:
      materialized: table
      tags: ['mart', 'marketing', 'performance', 'monthly']
    columns:
      - name: Company
        description: "The name of the company associated with the campaign metrics."
        tests:
          - not_null
          # Test that the combination of Company and month is unique
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - month
          # Ensure the company exists in the staging campaigns table
          - relationships:
              to: ref('stg_campaigns')
              field: Company

      - name: month
        description: "The calendar month (1-12) for which the metrics are aggregated."
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

      - name: campaign_count
        description: "Total number of campaigns run by the company during the month."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: avg_conversion_rate
        description: "Average conversion rate across all campaigns for the company in the month (e.g., 0.08 for 8%)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              # Conversion rate typically shouldn't exceed 1 (100%)
              max_value: 1

      - name: avg_roi
        description: "Average Return on Investment (ROI) across all campaigns for the company in the month."
        tests:
          - not_null
          # ROI can be negative if costs exceed revenue derived from investment
          - dbt_utils.accepted_range:
              min_value: -1 # Allows for up to 100% loss

      - name: avg_acquisition_cost
        description: "Average cost to acquire a customer or achieve a conversion goal across all campaigns for the company in the month."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: avg_ctr
        description: "Average Click-Through Rate (CTR) across all campaigns for the company in the month (e.g., 0.32 for 32%)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              # CTR typically shouldn't exceed 1 (100%)
              max_value: 1

      - name: total_clicks
        description: "Total number of clicks generated by the company's campaigns during the month."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: total_impressions
        description: "Total number of impressions served by the company's campaigns during the month."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: total_spend
        description: "Total advertising spend by the company during the month. Calculated as the sum of Acquisition_Cost from campaigns."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: total_revenue
        description: "Estimated total revenue generated by the company's campaigns during the month, calculated as total_spend * avg_roi."
        tests:
          - not_null
          # Revenue can be negative if ROI is negative. No strict lower bound applied here.

      - name: roi_vs_prev_month
        description: "Percentage change in average ROI compared to the previous month for the company. Null for the first available month of data for each company."
        # No not_null test as NULLs are expected for the first month.
        # Range can vary widely, so no range test applied.

      - name: conversion_rate_vs_prev_month
        description: "Percentage change in average conversion rate compared to the previous month for the company. Null for the first available month of data for each company."
        # No not_null test as NULLs are expected for the first month.

      - name: acquisition_cost_vs_prev_month
        description: "Percentage change in average acquisition cost compared to the previous month for the company (positive value indicates improvement/lower cost). Null for the first available month of data for each company."
        # No not_null test as NULLs are expected for the first month.

      - name: ctr_vs_prev_month
        description: "Percentage change in average CTR compared to the previous month for the company. Null for the first available month of data for each company."
        # No not_null test as NULLs are expected for the first month.