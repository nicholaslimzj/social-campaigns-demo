version: 2

models:
  - name: campaign_monthly_metrics
    description: |
      Aggregates campaign performance metrics by company and month.
      This model provides a time-based view of campaign effectiveness for each company,
      calculating key metrics, spend, revenue, and month-over-month percentage changes.
      It serves reporting dashboards focused on company-specific monthly trends,
      seasonal analysis, and performance comparisons.
    config:
      materialized: table
      tags: ['mart', 'marketing', 'reporting', 'monthly']
    columns:
      - name: Company
        description: "Identifier for the company associated with the campaign metrics. Used for partitioning MoM calculations."
        tests:
          - not_null
          # The combination of Company and month serves as the unique key for this aggregation level.
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - month

      - name: month
        description: "The calendar month (1-12) for which the metrics are aggregated."
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

      - name: campaign_count
        description: "The total number of campaigns run by the company during the month."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: avg_conversion_rate
        description: "The average conversion rate across all campaigns for the company in the month (expressed as a decimal, e.g., 0.08 for 8%)."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1 # Conversion rate typically between 0 and 1
              strictly: false # Allow 0 and 1

      - name: avg_roi
        description: "The average Return on Investment (ROI) across all campaigns for the company in the month."
        tests:
          - not_null
          # ROI can be negative if costs exceed revenue derived from it.

      - name: avg_acquisition_cost
        description: "The average cost per acquisition (e.g., click, lead, depending on source definition) for the company in the month."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: avg_ctr
        description: "The average Click-Through Rate (CTR) across all campaigns for the company in the month (expressed as a decimal)."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1 # CTR typically between 0 and 1
              strictly: false # Allow 0 and 1

      - name: total_clicks
        description: "The total number of clicks generated by the company's campaigns during the month."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: total_impressions
        description: "The total number of impressions served by the company's campaigns during the month."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: total_spend
        description: "Calculated total spend for the company's campaigns in the month (total_clicks * avg_acquisition_cost)."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: total_revenue
        description: "Calculated total revenue for the company's campaigns in the month (total_spend * avg_roi)."
        tests:
          - not_null
          # Revenue can be negative if ROI is negative.

      - name: roi_vs_prev_month
        description: "The percentage change in average ROI compared to the previous month for the company. Null if previous month data is unavailable."

      - name: conversion_rate_vs_prev_month
        description: "The percentage change in average conversion rate compared to the previous month for the company. Null if previous month data is unavailable or previous rate was zero."

      - name: acquisition_cost_vs_prev_month
        description: "The percentage change in average acquisition cost compared to the previous month for the company (positive value indicates improvement/lower cost). Null if previous month data is unavailable or previous cost was zero."

      - name: ctr_vs_prev_month
        description: "The percentage change in average CTR compared to the previous month for the company. Null if previous month data is unavailable or previous CTR was zero."