version: 2

models:
  - name: anomaly_flags
    description: |
      This mart model identifies anomalies in key marketing performance metrics for each company on a monthly basis.
      It first calculates monthly averages and totals for metrics like Conversion Rate, ROI, Acquisition Cost, Clicks, Impressions, and CTR from the staging campaign data.
      Then, it computes rolling 3-month statistics (mean and standard deviation, excluding the current month) for each metric per company.
      Finally, it calculates the Z-score for each metric in the current month compared to its rolling history and flags values as 'anomaly' if the absolute Z-score exceeds 2 standard deviations.
      A summary flag 'has_anomaly' indicates if any metric for a given company and month is anomalous.
    config:
      materialized: table
      tags: ['mart', 'anomaly_detection', 'marketing']
    columns:
      - name: Company
        description: "The name or identifier of the company."
        tests:
          - not_null
          # Test for the multi-column unique constraint (Company, month)
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - month
          # Ensure the company exists in the staging layer
          - relationships:
              to: ref('stg_campaigns')
              field: Company

      - name: month
        description: "The calendar month (1-12) for which the metrics are calculated."
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

      - name: avg_conversion_rate
        description: "The average conversion rate for the company during the specified month."
        # Data type: DOUBLE

      - name: conversion_rate_mean
        description: "The rolling average (mean) of the conversion rate over the 3 months preceding the specified month for the company. Can be NULL for early months."
        # Data type: DOUBLE

      - name: conversion_rate_std
        description: "The rolling population standard deviation of the conversion rate over the 3 months preceding the specified month for the company. Can be NULL for early months or if variance is zero."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0" # Standard deviation cannot be negative
        # Data type: DOUBLE

      - name: conversion_rate_z
        description: "The Z-score for the monthly average conversion rate, indicating how many standard deviations it is from the rolling 3-month mean. NULL if standard deviation is zero or undefined."
        # Data type: DOUBLE

      - name: conversion_rate_anomaly
        description: "Flag indicating if the monthly average conversion rate is considered an anomaly ('anomaly' if absolute Z-score > 2, 'normal' otherwise)."
        tests:
          - not_null
          - accepted_values:
              values: ['normal', 'anomaly']
        # Data type: VARCHAR

      - name: avg_roi
        description: "The average Return on Investment (ROI) for the company during the specified month."
        # Data type: DOUBLE

      - name: roi_mean
        description: "The rolling average (mean) of the ROI over the 3 months preceding the specified month for the company. Can be NULL for early months."
        # Data type: DOUBLE

      - name: roi_std
        description: "The rolling population standard deviation of the ROI over the 3 months preceding the specified month for the company. Can be NULL for early months or if variance is zero."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
        # Data type: DOUBLE

      - name: roi_z
        description: "The Z-score for the monthly average ROI. NULL if standard deviation is zero or undefined."
        # Data type: DOUBLE

      - name: roi_anomaly
        description: "Flag indicating if the monthly average ROI is considered an anomaly ('anomaly' if absolute Z-score > 2, 'normal' otherwise)."
        tests:
          - not_null
          - accepted_values:
              values: ['normal', 'anomaly']
        # Data type: VARCHAR

      - name: avg_acquisition_cost
        description: "The average Acquisition Cost for the company during the specified month."
        # Data type: DOUBLE

      - name: acquisition_cost_mean
        description: "The rolling average (mean) of the Acquisition Cost over the 3 months preceding the specified month for the company. Can be NULL for early months."
        # Data type: DOUBLE

      - name: acquisition_cost_std
        description: "The rolling population standard deviation of the Acquisition Cost over the 3 months preceding the specified month for the company. Can be NULL for early months or if variance is zero."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
        # Data type: DOUBLE

      - name: acquisition_cost_z
        description: "The Z-score for the monthly average Acquisition Cost. NULL if standard deviation is zero or undefined."
        # Data type: DOUBLE

      - name: acquisition_cost_anomaly
        description: "Flag indicating if the monthly average Acquisition Cost is considered an anomaly ('anomaly' if absolute Z-score > 2, 'normal' otherwise)."
        tests:
          - not_null
          - accepted_values:
              values: ['normal', 'anomaly']
        # Data type: VARCHAR

      - name: total_clicks
        description: "The total number of clicks for the company during the specified month."
        # Data type: HUGEINT

      - name: clicks_mean
        description: "The rolling average (mean) of total clicks over the 3 months preceding the specified month for the company. Can be NULL for early months."
        # Data type: DOUBLE

      - name: clicks_std
        description: "The rolling population standard deviation of total clicks over the 3 months preceding the specified month for the company. Can be NULL for early months or if variance is zero."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
        # Data type: DOUBLE

      - name: clicks_z
        description: "The Z-score for the monthly total clicks. NULL if standard deviation is zero or undefined."
        # Data type: DOUBLE

      - name: clicks_anomaly
        description: "Flag indicating if the monthly total clicks is considered an anomaly ('anomaly' if absolute Z-score > 2, 'normal' otherwise)."
        tests:
          - not_null
          - accepted_values:
              values: ['normal', 'anomaly']
        # Data type: VARCHAR

      - name: total_impressions
        description: "The total number of impressions for the company during the specified month."
        # Data type: HUGEINT

      - name: impressions_mean
        description: "The rolling average (mean) of total impressions over the 3 months preceding the specified month for the company. Can be NULL for early months."
        # Data type: DOUBLE

      - name: impressions_std
        description: "The rolling population standard deviation of total impressions over the 3 months preceding the specified month for the company. Can be NULL for early months or if variance is zero."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
        # Data type: DOUBLE

      - name: impressions_z
        description: "The Z-score for the monthly total impressions. NULL if standard deviation is zero or undefined."
        # Data type: DOUBLE

      - name: impressions_anomaly
        description: "Flag indicating if the monthly total impressions is considered an anomaly ('anomaly' if absolute Z-score > 2, 'normal' otherwise)."
        tests:
          - not_null
          - accepted_values:
              values: ['normal', 'anomaly']
        # Data type: VARCHAR

      - name: monthly_ctr
        description: "The calculated Click-Through Rate (CTR) for the company during the specified month (Total Clicks / Total Impressions)."
        # Data type: FLOAT

      - name: ctr_mean
        description: "The rolling average (mean) of the monthly CTR over the 3 months preceding the specified month for the company. Can be NULL for early months."
        # Data type: DOUBLE

      - name: ctr_std
        description: "The rolling population standard deviation of the monthly CTR over the 3 months preceding the specified month for the company. Can be NULL for early months or if variance is zero."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
        # Data type: DOUBLE

      - name: ctr_z
        description: "The Z-score for the monthly CTR. NULL if standard deviation is zero or undefined."
        # Data type: DOUBLE

      - name: ctr_anomaly
        description: "Flag indicating if the monthly CTR is considered an anomaly ('anomaly' if absolute Z-score > 2, 'normal' otherwise)."
        tests:
          - not_null
          - accepted_values:
              values: ['normal', 'anomaly']
        # Data type: VARCHAR

      - name: has_anomaly
        description: "A boolean flag indicating if *any* of the calculated metrics for the company in the specified month were flagged as an anomaly."
        tests:
          - not_null
          - accepted_values:
              values: [True, False] # Assuming boolean type maps to True/False
        # Data type: BOOLEAN