version: 2

models:
  - name: audience_metrics
    description: "Aggregates key campaign performance metrics by target audience, providing insights into audience-specific effectiveness. This model groups data from the staging layer to calculate totals and averages for metrics like clicks, impressions, cost, ROI, and conversion rates per audience segment."
    config:
      materialized: table
      tags: ['mart']
    columns:
      - name: Target_Audience
        description: "The specific demographic or group targeted by the campaigns (e.g., 'Men 35-44', 'Women 25-34'). This is the primary dimension for aggregation."
        tests:
          - not_null:
              description: "Target audience identifier should always be present as it's the grouping key."
          - unique:
              description: "Each target audience should appear only once in this aggregated table."
          - relationships:
              to: ref('stg_campaigns')
              field: Target_Audience
              description: "Ensures that every target audience in this mart model exists in the underlying staging campaign data."

      - name: campaign_count
        description: "The total number of distinct campaigns associated with this target audience."
        tests:
          - not_null:
              description: "Campaign count should always be calculated, even if zero (though typically > 0 if the audience exists)."
          # Consider adding a test for non-negativity if using dbt_expectations or similar packages:
          # - dbt_expectations.expect_column_values_to_be_non_negative

      - name: avg_conversion_rate
        description: "The average conversion rate across all campaigns for this target audience. Expressed as a decimal (e.g., 0.08 represents 8%)."
        tests:
          - not_null:
              description: "Average conversion rate should be calculable for each audience group."
          # Consider adding range tests (e.g., >= 0 and <= 1) if using dbt_expectations or dbt_utils:
          # - dbt_utils.accepted_range:
          #     min_value: 0
          #     max_value: 1 # Assuming conversion rate cannot exceed 100%

      - name: avg_roi
        description: "The average Return on Investment (ROI) calculated across campaigns for this target audience. ROI measures the profitability of the campaigns."
        tests:
          - not_null:
              description: "Average ROI should be calculable for each audience group."
          # ROI can be negative, so a simple non-negative test might not apply.

      - name: avg_acquisition_cost
        description: "The average cost to acquire a customer or achieve a primary conversion goal for campaigns targeting this audience."
        tests:
          - not_null:
              description: "Average acquisition cost should be calculable for each audience group."
          # Consider adding a test for non-negativity if using dbt_expectations:
          # - dbt_expectations.expect_column_values_to_be_non_negative

      - name: total_clicks
        description: "The sum total number of clicks generated by all campaigns targeting this specific audience."
        tests:
          - not_null:
              description: "Total clicks should always be calculated, even if zero."
          # Consider adding a test for non-negativity if using dbt_expectations:
          # - dbt_expectations.expect_column_values_to_be_non_negative

      - name: total_impressions
        description: "The sum total number of times ads were displayed (impressions) for campaigns targeting this specific audience."
        tests:
          - not_null:
              description: "Total impressions should always be calculated, even if zero."
          # Consider adding a test for non-negativity if using dbt_expectations:
          # - dbt_expectations.expect_column_values_to_be_non_negative

      - name: overall_ctr
        description: "The overall Click-Through Rate (CTR) for this target audience, calculated as (Total Clicks / Total Impressions). Expressed as a decimal."
        tests:
          - not_null:
              description: "Overall CTR should be calculable for each audience group."
          # Consider adding range tests (e.g., >= 0 and <= 1) if using dbt_expectations or dbt_utils:
          # - dbt_utils.accepted_range:
          #     min_value: 0
          #     # max_value: 1 # CTR theoretically shouldn't exceed 1, but allow flexibility unless strictly enforced.