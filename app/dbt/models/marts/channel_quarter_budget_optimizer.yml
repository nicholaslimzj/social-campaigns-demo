version: 2

models:
  - name: channel_quarter_budget_optimizer
    description: |
      Analyzes marketing channel performance over the current quarter (last 3 months of data) to recommend optimal budget allocations.
      Calculates key performance and efficiency metrics (ROI, CPA, CTR) per channel, determines optimal spend percentages based on historical performance and a simplified marginal returns model,
      and compares optimal vs. current allocation. Includes projected performance improvements and constraints like minimum spend and maximum capacity.
      Designed for budget planning and optimization dashboards.
    config:
      materialized: table
      tags: ['mart', 'marketing', 'budgeting', 'optimization', 'quarterly']
    columns:
      - name: Channel_Used
        description: "The marketing channel being analyzed (e.g., Instagram, Facebook, Twitter)."
        data_type: VARCHAR
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Channel_Used
              description: "Ensures the channel exists in the underlying campaign data."

      - name: campaign_count
        description: "Number of distinct campaigns run on this channel during the current quarter."
        data_type: BIGINT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              description: "Campaign count cannot be negative."

      - name: company_count
        description: "Number of distinct companies utilizing this channel during the current quarter."
        data_type: BIGINT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              description: "Company count cannot be negative."

      - name: total_spend
        description: "Total amount spent on this channel during the current quarter."
        data_type: DOUBLE
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              description: "Total spend should not be negative."

      - name: total_revenue
        description: "Total revenue attributed to this channel during the current quarter, calculated as SUM(Clicks * Acquisition_Cost * ROI)."
        data_type: DOUBLE
        tests:
          - not_null

      - name: avg_roi
        description: "Average Return on Investment (ROI) for campaigns on this channel during the current quarter."
        data_type: DOUBLE
        tests:
          - not_null

      - name: avg_conversion_rate
        description: "Average conversion rate for campaigns on this channel during the current quarter."
        data_type: DOUBLE
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1 # Conversion rate should be between 0 and 1
              description: "Average conversion rate must be between 0 and 1."

      - name: avg_acquisition_cost
        description: "Average acquisition cost (CPA) for campaigns on this channel during the current quarter."
        data_type: DOUBLE
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              description: "Average acquisition cost cannot be negative."

      - name: avg_ctr
        description: "Average Click-Through Rate (CTR) for campaigns on this channel during the current quarter."
        data_type: FLOAT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1 # CTR should be between 0 and 1
              description: "Average CTR must be between 0 and 1."

      - name: roi_efficiency
        description: "Overall ROI efficiency calculated for the channel (Total Revenue / Total Spend) during the current quarter."
        data_type: DOUBLE
        tests:
          - not_null

      - name: cost_per_click
        description: "Calculated Cost Per Click (CPC) for the channel (Total Spend / Total Clicks) during the current quarter."
        data_type: DOUBLE
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              description: "Cost per click cannot be negative."

      - name: click_through_rate
        description: "Overall Click-Through Rate (CTR) for the channel (Total Clicks / Total Impressions) during the current quarter."
        data_type: FLOAT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1 # CTR should be between 0 and 1
              description: "Overall CTR must be between 0 and 1."

      - name: current_spend_share
        description: "The channel's current share of the total marketing spend across all channels during the quarter (Channel Spend / Total Spend)."
        data_type: DOUBLE
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1 # Share must be between 0 and 1
              description: "Current spend share must be between 0 and 1."

      - name: current_revenue_share
        description: "The channel's current share of the total marketing revenue across all channels during the quarter (Channel Revenue / Total Revenue)."
        data_type: DOUBLE
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              # Max value can theoretically exceed 1 if other channels have negative revenue, but typically <= 1
              description: "Current revenue share must be non-negative."

      - name: efficiency_rank
        description: "Rank of the channel based on its calculated marginal ROI (1 = highest marginal ROI)."
        data_type: BIGINT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
              description: "Efficiency rank must be a positive integer."

      - name: optimal_spend_share
        description: "The recommended optimal share of the total budget for this channel based on the optimization model, normalized to sum to 1 across channels."
        data_type: DOUBLE
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1 # Share must be between 0 and 1
              description: "Optimal spend share must be between 0 and 1."

      - name: spend_share_change
        description: "The calculated change between the optimal spend share and the current spend share (Optimal Share - Current Share)."
        data_type: DOUBLE
        tests:
          - not_null

      - name: current_spend
        description: "Absolute current spend for the channel during the quarter (same value as total_spend, included for direct comparison)."
        data_type: DOUBLE
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              description: "Current spend should not be negative."

      - name: optimal_spend
        description: "The recommended absolute budget allocation for this channel based on the optimal spend share and the total available budget."
        data_type: DOUBLE
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              description: "Optimal spend should not be negative."

      - name: spend_change
        description: "The calculated change in absolute spend required to reach the optimal allocation (Optimal Spend - Current Spend)."
        data_type: DOUBLE
        tests:
          - not_null

      - name: projected_revenue
        description: "Projected revenue for the channel if the optimal budget allocation is implemented (based on a simplified projection model incorporating diminishing returns)."
        data_type: DOUBLE
        tests:
          - not_null

      - name: projected_roi
        description: "Projected ROI for the channel if the optimal budget allocation is implemented (based on a simplified projection model)."
        data_type: DOUBLE
        tests:
          - not_null

      - name: projected_improvement_pct
        description: "Projected percentage improvement in revenue compared to the current revenue if the optimal budget is adopted."
        data_type: DOUBLE
        tests:
          - not_null

      - name: recommendation_strength
        description: "Categorization of the recommended budget change magnitude based on the difference between optimal and current spend share (minor, moderate, major)."
        data_type: VARCHAR
        tests:
          - not_null
          - accepted_values:
              values: ['minor_adjustment', 'moderate_adjustment', 'major_adjustment']
              description: "Recommendation strength must be one of the predefined categories."

      - name: recommendation_direction
        description: "Direction of the recommended budget change based on whether optimal spend share is higher, lower, or the same as current (increase, decrease, maintain)."
        data_type: VARCHAR
        tests:
          - not_null
          - accepted_values:
              values: ['increase_spend', 'decrease_spend', 'maintain_spend']
              description: "Recommendation direction must be one of the predefined categories."