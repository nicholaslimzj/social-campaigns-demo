version: 2

models:
  - name: channel_quarter_budget_optimizer
    description: "Mart model analyzing channel performance for the current quarter (last 3 months of available data) to provide optimal budget allocation recommendations across channels within each company. It calculates key efficiency metrics (ROI, CPA, CTR), models marginal returns (simplified), determines optimal spend shares considering minimum/maximum constraints, projects potential revenue/ROI improvements, and compares optimal vs. current allocation. Designed for use in budget optimization dashboards and strategic planning."
    config:
      materialized: table
      tags: ['mart', 'marketing', 'optimization', 'budgeting', 'quarterly']
    columns:
      - name: Company
        description: "The name of the company being analyzed. Part of the unique key for this model."
        tests:
          - not_null
          # Define the multi-column unique key on one of the participating columns
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - Channel_Used
          # Ensure Company values exist in the staging layer
          - relationships:
              to: ref('stg_campaigns')
              field: Company

      - name: Channel_Used
        description: "The marketing channel used (e.g., Instagram, Facebook, Twitter). Part of the unique key for this model."
        tests:
          - not_null
          # Ensure Channel_Used values exist in the staging layer
          - relationships:
              to: ref('stg_campaigns')
              field: Channel_Used

      - name: campaign_count
        description: "Number of distinct campaigns run by the company on this channel during the analyzed quarter."
        tests:
          - dbt_utils.not_negative

      - name: company_count
        description: "Helper column indicating count of companies (always 1 at this aggregation level of Company and Channel)."

      - name: total_spend
        description: "Total spend attributed to this channel for the company during the analyzed quarter. Calculated as SUM(Clicks * Conversion_Rate * Acquisition_Cost)."
        tests:
          - dbt_utils.not_negative

      - name: total_revenue
        description: "Total revenue attributed to this channel for the company during the analyzed quarter. Calculated as SUM(Clicks * Conversion_Rate * Acquisition_Cost * (1 + ROI))."
        tests:
          - dbt_utils.not_negative

      - name: avg_roi
        description: "Average Return on Investment (ROI) for campaigns on this channel during the analyzed quarter."

      - name: avg_conversion_rate
        description: "Average conversion rate for campaigns on this channel during the analyzed quarter."
        tests:
          - dbt_utils.not_negative

      - name: avg_acquisition_cost
        description: "Average cost per acquisition (CPA) for campaigns on this channel during the analyzed quarter."
        tests:
          - dbt_utils.not_negative

      - name: avg_ctr
        description: "Average click-through rate (CTR) calculated as SUM(Clicks) / NULLIF(SUM(Impressions), 0) for this channel/company in the quarter."
        tests:
          - dbt_utils.not_negative

      - name: roi_efficiency
        description: "Calculated efficiency metric: Total Revenue / Total Spend for this channel/company in the quarter. Returns 0 if total spend is 0."
        tests:
          - dbt_utils.not_negative

      - name: cost_per_click
        description: "Calculated cost per click (CPC) for this channel/company in the quarter: Total Spend / Total Clicks. Returns 0 if total clicks is 0."
        tests:
          - dbt_utils.not_negative

      - name: click_through_rate
        description: "Calculated overall click-through rate (CTR) for this channel/company in the quarter: Total Clicks / Total Impressions. Returns 0 if total impressions is 0."
        tests:
          - dbt_utils.not_negative
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1 # CTR should be between 0 and 1

      - name: current_spend_share
        description: "The proportion of the company's total quarterly spend allocated to this channel currently."
        tests:
          - dbt_utils.not_negative
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1 # Share should be between 0 and 1

      - name: current_revenue_share
        description: "The proportion of the company's total quarterly revenue generated by this channel currently."
        tests:
          - dbt_utils.not_negative
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              # Revenue share can theoretically exceed 1 if other channels have negative revenue, though unlikely here.
              # max_value: 1

      - name: efficiency_rank
        description: "Rank of the channel within the company based on descending marginal ROI (1 = highest estimated marginal return)."
        tests:
          - dbt_utils.not_negative # Rank starts at 1

      - name: optimal_spend_share
        description: "The recommended optimal proportion of the company's total budget to allocate to this channel, based on the simplified optimization model and normalized to sum to 1 across channels for the company."
        tests:
          - dbt_utils.not_negative
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1 # Share should be between 0 and 1
          # Note: Testing that shares sum to 1 per company requires a custom aggregate test.

      - name: spend_share_change
        description: "The calculated change between the optimal spend share and the current spend share (Optimal - Current). Indicates the recommended shift in budget allocation percentage."

      - name: current_spend
        description: "The absolute current spend on this channel for the company in the quarter (same value as total_spend, included for direct comparison)."
        tests:
          - dbt_utils.not_negative

      - name: optimal_spend
        description: "The recommended absolute spend amount for this channel based on the optimal spend share applied to the company's total current spend."
        tests:
          - dbt_utils.not_negative

      - name: spend_change
        description: "The calculated absolute change in spend recommended (Optimal Spend - Current Spend)."

      - name: projected_revenue
        description: "Estimated revenue for this channel if the optimal spend allocation is adopted, based on a simplified projection model incorporating diminishing/increasing returns."
        tests:
          - dbt_utils.not_negative

      - name: projected_roi
        description: "Estimated ROI for this channel if the optimal spend allocation is adopted, based on a simplified projection model incorporating diminishing/increasing returns."

      - name: projected_improvement_pct
        description: "Projected percentage change in revenue compared to current revenue if optimal allocation is adopted ((Projected Revenue - Current Revenue) / Current Revenue). Returns 0 if current revenue is 0."

      - name: recommendation_strength
        description: "Categorical assessment of the magnitude of the recommended spend change based on the absolute difference between optimal and current spend share."
        tests:
          - accepted_values:
              values: ['minor_adjustment', 'moderate_adjustment', 'major_adjustment']

      - name: recommendation_direction
        description: "Direction of the recommended spend change (increase, decrease, or maintain)."
        tests:
          - accepted_values:
              values: ['increase_spend', 'decrease_spend', 'maintain_spend']