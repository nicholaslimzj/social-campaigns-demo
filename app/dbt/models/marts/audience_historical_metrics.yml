version: 2

models:
  - name: audience_historical_metrics
    description: "Aggregates historical campaign performance metrics grouped by target audience. Provides insights into audience-level effectiveness, supports audience comparison, and informs targeting strategies. This model serves data for audience performance dashboards and demographic targeting analysis."
    config:
      materialized: table
      tags: ['mart', 'audience', 'performance', 'historical', 'marketing']
    columns:
      - name: Target_Audience
        description: "The specific demographic or behavioral group targeted by campaigns (e.g., 'Women 25-34', 'Men 45-60'). This is the primary grouping key for the aggregated metrics."
        tests:
          - unique
          - not_null
          # Optional: Add relationship test if stg_campaigns.Target_Audience is guaranteed to contain all values present here.
          # - relationships:
          #     to: ref('stg_campaigns')
          #     field: Target_Audience

      - name: campaign_count
        description: "The total number of distinct campaigns associated with this target audience."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_positive:
              strictly: false # Allow zero

      - name: avg_conversion_rate
        description: "The average conversion rate across all campaigns targeting this audience. Typically calculated as (Total Conversions / Total Clicks or Sessions) averaged per campaign or aggregated."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              # Max value can exceed 1 depending on definition, omit unless strictly 0-1
              row_condition: "Target_Audience IS NOT NULL" # Apply test only to valid rows

      - name: avg_roi
        description: "The average Return On Investment (ROI) for campaigns targeting this audience. Calculated as (Total Revenue - Total Cost) / Total Cost, averaged across campaigns."
        tests:
          - not_null
          # ROI can be negative, so no non-negative test applied.

      - name: avg_acquisition_cost
        description: "The average cost to acquire a customer (CAC) or achieve a specific conversion goal for campaigns targeting this audience."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_positive:
              strictly: false # Allow zero

      - name: total_clicks
        description: "The total number of clicks generated by all campaigns targeting this audience across the entire historical dataset."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_positive:
              strictly: false # Allow zero

      - name: total_impressions
        description: "The total number of impressions served by all campaigns targeting this audience across the entire historical dataset."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_positive:
              strictly: false # Allow zero

      - name: overall_ctr
        description: "The overall Click-Through Rate (CTR) for this audience, calculated as (Total Clicks / Total Impressions) across all associated campaigns."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1 # Assuming CTR is strictly clicks/impressions and cannot exceed 1
              row_condition: "total_impressions > 0" # CTR is only meaningful if impressions > 0