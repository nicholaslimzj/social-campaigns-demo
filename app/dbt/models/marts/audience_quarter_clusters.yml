version: 2

models:
  - name: audience_quarter_clusters
    description: "Identifies high-performing target audience clusters for the current quarter (last 3 months of data). It analyzes combinations of Company, Target_Audience, Location, Channel, and Goal to find optimal groupings based on performance metrics like ROI, conversion rate, CTR, and acquisition cost. Calculates normalized scores (z-scores), ranks clusters within companies and audiences, assigns performance tiers, and provides actionable recommendations. Used in the Cohort Analysis dashboard."
    config:
      materialized: table
      tags: ['mart', 'audience', 'performance', 'quarterly', 'cohort_analysis']
    columns:
      - name: Company
        description: "The company associated with the marketing campaigns."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Company
          # This combination defines the unique grain of the model
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - Target_Audience
                - Location
                - channel
                - goal

      - name: Target_Audience
        description: "The specific audience segment targeted by the campaigns within the cluster."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Target_Audience

      - name: Location
        description: "The geographical location associated with the campaigns in the cluster."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Location

      - name: channel
        description: "The marketing channel used for the campaigns in the cluster (e.g., Facebook, Twitter, Instagram)."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Channel_Used # Assuming this is the corresponding field in stg_campaigns

      - name: goal
        description: "The primary goal of the campaigns within the cluster (e.g., Increase Sales, Brand Awareness)."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Campaign_Goal # Assuming this is the corresponding field in stg_campaigns

      - name: campaign_count
        description: "The number of individual campaigns grouped within this specific cluster. Clusters require a minimum of 3 campaigns."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 3 # Based on HAVING COUNT(*) >= 3

      - name: avg_conversion_rate
        description: "The average conversion rate for the campaigns within this cluster."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: avg_roi
        description: "The average Return on Investment (ROI) for the campaigns within this cluster."
        tests:
          - not_null

      - name: avg_acquisition_cost
        description: "The average cost to acquire a customer for the campaigns within this cluster."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: avg_ctr
        description: "The average Click-Through Rate (CTR) for the campaigns within this cluster (Clicks / Impressions)."
        # CTR can be null if Impressions are 0, although HAVING COUNT(*) >= 3 makes this less likely.
        # No not_null test applied.
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              # max_value: 1 # CTR can sometimes exceed 1 depending on definition/tracking issues, safer to omit max unless strictly enforced.
              where: "avg_ctr IS NOT NULL" # Apply range test only where CTR is calculable

      - name: total_spend
        description: "The total marketing spend for all campaigns within this cluster."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: total_revenue
        description: "The total calculated revenue generated by the campaigns within this cluster (based on spend and ROI)."
        tests:
          - not_null
          # Revenue could theoretically be negative if ROI is significantly negative.

      - name: avg_audience_conversion_rate
        description: "The average conversion rate across all clusters for the same Company and Target Audience."
        tests:
          - not_null

      - name: avg_audience_roi
        description: "The average ROI across all clusters for the same Company and Target Audience."
        tests:
          - not_null

      - name: avg_audience_ctr
        description: "The average CTR across all clusters for the same Company and Target Audience."
        tests:
          - not_null

      - name: avg_audience_acquisition_cost
        description: "The average acquisition cost across all clusters for the same Company and Target Audience."
        tests:
          - not_null

      - name: cluster_count
        description: "The total number of distinct clusters identified for the same Company and Target Audience."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: conversion_rate_z_score
        description: "The normalized performance score (z-score) for average conversion rate, comparing the cluster's rate to the company average."
        tests:
          - not_null

      - name: roi_z_score
        description: "The normalized performance score (z-score) for average ROI, comparing the cluster's ROI to the company average."
        tests:
          - not_null

      - name: ctr_z_score
        description: "The normalized performance score (z-score) for average CTR, comparing the cluster's CTR to the company average."
        tests:
          - not_null

      - name: cost_efficiency_z_score
        description: "The normalized performance score (z-score) for cost efficiency (inverted average acquisition cost), comparing the cluster's cost to the company average. Higher is better (more efficient)."
        tests:
          - not_null

      - name: composite_performance_score
        description: "A weighted average of the z-scores for conversion rate (35%), ROI (35%), CTR (15%), and cost efficiency (15%), providing an overall cluster performance measure relative to the company average."
        tests:
          - not_null

      - name: roi_rank
        description: "The rank of this cluster within the Company based on average ROI (1 = highest ROI)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: conversion_rate_rank
        description: "The rank of this cluster within the Company based on average conversion rate (1 = highest conversion rate)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: acquisition_cost_rank
        description: "The rank of this cluster within the Company based on average acquisition cost (1 = lowest acquisition cost)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: audience_roi_rank
        description: "The rank of this cluster within the Company and Target Audience based on average ROI (1 = highest ROI)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: audience_conversion_rate_rank
        description: "The rank of this cluster within the Company and Target Audience based on average conversion rate (1 = highest conversion rate)."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: roi_percentile
        description: "The percentile rank of the cluster within the Company based on ROI rank (e.g., 0.1 means top 10%). Lower values indicate better relative ROI performance."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1

      - name: is_high_performing_cluster
        description: "Boolean flag indicating if the cluster ranks in the top 10% based on the composite performance score within its Company."
        tests:
          - not_null
          - accepted_values:
              values: [True, False] # Boolean values represented directly

      - name: performance_tier
        description: "Categorical tier assigned based on the composite performance score ('Exceptional', 'High Performing', 'Average', 'Underperforming', 'Poor')."
        tests:
          - not_null
          - accepted_values:
              values: ['Exceptional', 'High Performing', 'Average', 'Underperforming', 'Poor']

      - name: recommended_action
        description: "Suggested action based on the cluster's performance tier (e.g., 'Increase investment', 'Monitor and optimize')."
        tests:
          - not_null
          - accepted_values:
              values: ['Increase investment', 'Maintain or increase', 'Monitor and optimize', 'Reduce investment', 'Consider discontinuing']