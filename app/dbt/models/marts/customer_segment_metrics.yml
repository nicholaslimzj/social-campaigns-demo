version: 2

models:
  - name: customer_segment_metrics
    description: "Aggregates key campaign performance metrics from `stg_campaigns` for each distinct customer segment. Provides a high-level view of segment performance across various dimensions like cost, engagement, and return on investment."
    config:
      materialized: table
      tags: ['mart', 'marketing', 'segment_analysis']
    columns:
      - name: Customer_Segment
        description: "The distinct customer segment targeted by the campaigns. This serves as the primary dimension for grouping campaign metrics."
        tests:
          - not_null:
              description: "Customer segment identifier should always be present."
          - unique:
              description: "Each row in this aggregated table represents a unique customer segment."
          - relationships:
              to: ref('stg_campaigns')
              field: Customer_Segment
              description: "Ensures that every customer segment in this mart model exists in the staging layer."

      - name: campaign_count
        description: "The total number of campaigns associated with this customer segment."
        tests:
          - not_null:
              description: "Campaign count should be calculated for every segment."
          - dbt_expectations.expect_column_values_to_be_non_negative:
              description: "The count of campaigns cannot be negative."

      - name: avg_conversion_rate
        description: "The average conversion rate across all campaigns targeting this customer segment. Typically calculated as (Total Conversions / Total Clicks or Impressions) averaged per campaign."
        tests:
          - not_null:
              description: "Average conversion rate should be calculated for every segment."
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              # Max value could theoretically exceed 1 in some niche definitions, but typically it's capped at 1 (100%).
              # Adjust if business logic allows > 1.
              max_value: 1
              description: "Conversion rates are typically expressed as a value between 0 and 1."

      - name: avg_roi
        description: "The average Return on Investment (ROI) across all campaigns targeting this customer segment. Calculated as ((Revenue - Cost) / Cost) averaged per campaign."
        tests:
          - not_null:
              description: "Average ROI should be calculated for every segment."
          # ROI can be negative, so a simple range test might not be suitable without specific business context.

      - name: avg_acquisition_cost
        description: "The average cost to acquire a customer (CAC) or achieve a conversion goal across all campaigns targeting this customer segment."
        tests:
          - not_null:
              description: "Average acquisition cost should be calculated for every segment."
          - dbt_expectations.expect_column_values_to_be_non_negative:
              description: "Acquisition cost cannot be negative."

      - name: total_clicks
        description: "The sum total number of clicks generated by all campaigns targeting this customer segment."
        tests:
          - not_null:
              description: "Total clicks should be calculated for every segment."
          - dbt_expectations.expect_column_values_to_be_non_negative:
              description: "The total number of clicks cannot be negative."

      - name: total_impressions
        description: "The sum total number of impressions served by all campaigns targeting this customer segment."
        tests:
          - not_null:
              description: "Total impressions should be calculated for every segment."
          - dbt_expectations.expect_column_values_to_be_non_negative:
              description: "The total number of impressions cannot be negative."

      - name: overall_ctr
        description: "The overall Click-Through Rate (CTR) for the customer segment, calculated as (Total Clicks / Total Impressions) across all associated campaigns."
        tests:
          - not_null:
              description: "Overall CTR should be calculated for every segment."
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1
              description: "Click-Through Rate (CTR) is expressed as a value between 0 and 1."