version: 2

models:
  - name: audience_quarter_performance_matrix
    description: >
      Analyzes audience performance metrics for the current quarter (last 3 months of available data).
      Aggregates campaign data by Company, Target Audience, and a specific dimension (Location, Language, or Campaign Goal).
      Calculates key performance indicators (KPIs) like Conversion Rate, ROI, Acquisition Cost, and CTR for each combination.
      Provides context by comparing combination performance against company, audience, dimension, and global averages.
      Includes normalized metrics (scaled 0-1), a weighted composite score for ranking, and flags top-performing combinations (top 10% by composite score within each dimension type).
      Designed for use in performance dashboards and identifying high-potential audience segments.
    config:
      materialized: table
      tags: ['mart', 'performance', 'audience_analysis', 'quarterly']
    columns:
      - name: Company
        description: "The primary dimension: Name of the company running the campaigns."
        tests:
          - not_null
          # Enforce uniqueness across the combination of key dimensions
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - Target_Audience
                - dimension_value
                - dimension_type

      - name: Target_Audience
        description: "The secondary dimension: The specific audience segment targeted by the campaigns for the company."
        tests:
          - not_null

      - name: dimension_value
        description: "The specific value of the tertiary dimension (e.g., 'USA', 'English', 'Brand Awareness')."
        tests:
          - not_null

      - name: dimension_type
        description: "The type of the tertiary dimension ('location', 'language', or 'goal')."
        tests:
          - not_null
          - accepted_values:
              values: ['location', 'language', 'goal']

      - name: campaign_count
        description: "The number of distinct campaigns contributing to this specific combination's metrics within the quarter."
        data_type: BIGINT
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: avg_conversion_rate
        description: "The average conversion rate for this Company-Audience-Dimension combination over the quarter."
        data_type: DOUBLE

      - name: avg_roi
        description: "The average Return on Investment (ROI) for this Company-Audience-Dimension combination over the quarter."
        data_type: DOUBLE

      - name: avg_acquisition_cost
        description: "The average cost to acquire a customer/conversion for this Company-Audience-Dimension combination over the quarter."
        data_type: DOUBLE
        tests:
          # Cost should generally not be negative, allowing for zero cost scenarios
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: avg_ctr
        description: "The average Click-Through Rate (Clicks / Impressions) for this Company-Audience-Dimension combination over the quarter."
        data_type: FLOAT
        tests:
          # CTR should be between 0 and 1 (or slightly higher in rare edge cases, but generally non-negative)
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: company_avg_conversion_rate
        description: "The average conversion rate across all audiences and dimensions for this Company over the quarter."
        data_type: DOUBLE

      - name: company_avg_roi
        description: "The average ROI across all audiences and dimensions for this Company over the quarter."
        data_type: DOUBLE

      - name: company_avg_acquisition_cost
        description: "The average acquisition cost across all audiences and dimensions for this Company over the quarter."
        data_type: DOUBLE

      - name: company_avg_ctr
        description: "The average CTR across all audiences and dimensions for this Company over the quarter."
        data_type: DOUBLE

      - name: audience_avg_conversion_rate
        description: "The average conversion rate for this specific Target Audience across all dimensions within this Company over the quarter."
        data_type: DOUBLE

      - name: audience_avg_roi
        description: "The average ROI for this specific Target Audience across all dimensions within this Company over the quarter."
        data_type: DOUBLE

      - name: audience_avg_acquisition_cost
        description: "The average acquisition cost for this specific Target Audience across all dimensions within this Company over the quarter."
        data_type: DOUBLE

      - name: audience_avg_ctr
        description: "The average CTR for this specific Target Audience across all dimensions within this Company over the quarter."
        data_type: DOUBLE

      - name: dimension_avg_conversion_rate
        description: "The average conversion rate for this specific dimension value (e.g., 'USA') across all target audiences within this Company over the quarter."
        data_type: DOUBLE

      - name: dimension_avg_roi
        description: "The average ROI for this specific dimension value across all target audiences within this Company over the quarter."
        data_type: DOUBLE

      - name: dimension_avg_acquisition_cost
        description: "The average acquisition cost for this specific dimension value across all target audiences within this Company over the quarter."
        data_type: DOUBLE

      - name: dimension_avg_ctr
        description: "The average CTR for this specific dimension value across all target audiences within this Company over the quarter."
        data_type: DOUBLE

      - name: global_avg_conversion_rate
        description: "The global average conversion rate across all companies, audiences, and dimensions over the quarter."
        data_type: DOUBLE

      - name: global_avg_roi
        description: "The global average ROI across all companies, audiences, and dimensions over the quarter."
        data_type: DOUBLE

      - name: global_avg_acquisition_cost
        description: "The global average acquisition cost across all companies, audiences, and dimensions over the quarter."
        data_type: DOUBLE

      - name: global_avg_ctr
        description: "The global average CTR across all companies, audiences, and dimensions over the quarter."
        data_type: DOUBLE

      - name: conversion_rate_vs_company_avg
        description: "Percentage difference of this combination's conversion rate compared to the company's average conversion rate. (Metric / Company Avg) - 1."
        data_type: DOUBLE

      - name: roi_vs_company_avg
        description: "Percentage difference of this combination's ROI compared to the company's average ROI. (Metric / Company Avg) - 1."
        data_type: DOUBLE

      - name: acquisition_cost_vs_company_avg
        description: "Percentage difference of this combination's acquisition cost compared to the company's average acquisition cost (inverted for performance: (Company Avg / Metric) - 1)."
        data_type: DOUBLE

      - name: ctr_vs_company_avg
        description: "Percentage difference of this combination's CTR compared to the company's average CTR. (Metric / Company Avg) - 1."
        data_type: DOUBLE

      - name: conversion_rate_vs_audience_avg
        description: "Percentage difference of this combination's conversion rate compared to the average for this specific audience within the company. (Metric / Audience Avg) - 1."
        data_type: DOUBLE

      - name: roi_vs_audience_avg
        description: "Percentage difference of this combination's ROI compared to the average for this specific audience within the company. (Metric / Audience Avg) - 1."
        data_type: DOUBLE

      - name: acquisition_cost_vs_audience_avg
        description: "Percentage difference of this combination's acquisition cost compared to the average for this specific audience within the company (inverted: (Audience Avg / Metric) - 1)."
        data_type: DOUBLE

      - name: ctr_vs_audience_avg
        description: "Percentage difference of this combination's CTR compared to the average for this specific audience within the company. (Metric / Audience Avg) - 1."
        data_type: DOUBLE

      - name: conversion_rate_vs_dimension_avg
        description: "Percentage difference of this combination's conversion rate compared to the average for this specific dimension value within the company. (Metric / Dimension Avg) - 1."
        data_type: DOUBLE

      - name: roi_vs_dimension_avg
        description: "Percentage difference of this combination's ROI compared to the average for this specific dimension value within the company. (Metric / Dimension Avg) - 1."
        data_type: DOUBLE

      - name: acquisition_cost_vs_dimension_avg
        description: "Percentage difference of this combination's acquisition cost compared to the average for this specific dimension value within the company (inverted: (Dimension Avg / Metric) - 1)."
        data_type: DOUBLE

      - name: ctr_vs_dimension_avg
        description: "Percentage difference of this combination's CTR compared to the average for this specific dimension value within the company. (Metric / Dimension Avg) - 1."
        data_type: DOUBLE

      - name: conversion_rate_vs_global_avg
        description: "Percentage difference of this combination's conversion rate compared to the global average conversion rate. (Metric / Global Avg) - 1."
        data_type: DOUBLE

      - name: roi_vs_global_avg
        description: "Percentage difference of this combination's ROI compared to the global average ROI. (Metric / Global Avg) - 1."
        data_type: DOUBLE

      - name: acquisition_cost_vs_global_avg
        description: "Percentage difference of this combination's acquisition cost compared to the global average acquisition cost (inverted: (Global Avg / Metric) - 1)."
        data_type: DOUBLE

      - name: ctr_vs_global_avg
        description: "Percentage difference of this combination's CTR compared to the global average CTR. (Metric / Global Avg) - 1."
        data_type: DOUBLE

      - name: normalized_conversion_rate
        description: "Conversion rate normalized to a 0-1 scale across all combinations in the dataset for the quarter. Higher is better."
        data_type: DOUBLE
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1
              strictly: false
              allow_nulls: true # Can be null if min=max

      - name: normalized_roi
        description: "ROI normalized to a 0-1 scale across all combinations in the dataset for the quarter. Higher is better."
        data_type: DOUBLE
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1
              strictly: false
              allow_nulls: true # Can be null if min=max

      - name: normalized_acquisition_cost
        description: "Acquisition cost normalized to a 0-1 scale across all combinations (inverted, so 1 is best/lowest cost) for the quarter."
        data_type: DOUBLE
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1
              strictly: false
              allow_nulls: true # Can be null if min=max

      - name: normalized_ctr
        description: "CTR normalized to a 0-1 scale across all combinations in the dataset for the quarter. Higher is better."
        data_type: FLOAT
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1
              strictly: false
              allow_nulls: true # Can be null if min=max

      - name: composite_score
        description: "A weighted score (0-1) combining normalized ROI (40%), Conversion Rate (30%), Acquisition Cost (20%, inverted), and CTR (10%). Used for ranking combinations. Null if campaign_count is 0."
        data_type: DOUBLE
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1
              strictly: false
              allow_nulls: true # Can be null if campaign_count=0 or min=max for all metrics

      - name: is_top_performer
        description: "Boolean flag indicating if this combination ranks in the top 10% based on the composite_score within its dimension_type for the quarter."
        data_type: BOOLEAN
        tests:
          - not_null # The CASE statement ensures this is always TRUE or FALSE