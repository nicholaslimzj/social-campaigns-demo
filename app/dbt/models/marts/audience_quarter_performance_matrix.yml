version: 2

models:
  - name: audience_quarter_performance_matrix
    description: |
      Analyzes audience performance metrics over the current quarter (last 3 months of data).
      Calculates key performance indicators (KPIs) like conversion rate, ROI, acquisition cost, and CTR
      for combinations of Company, Target Audience, and a tertiary dimension (Location, Language, or Campaign Goal).
      Provides comparative metrics against company, audience, dimension, and global averages.
      Includes normalized metrics, a weighted composite score for ranking, and a flag for top performers.
      Designed for use in performance matrix heatmaps and comparative visualizations.
    config:
      materialized: table
      tags:
        - 'mart'
        - 'performance'
        - 'audience'
        - 'quarterly'
        - 'marketing'
    columns:
      - name: Company
        description: "Name of the company running the campaigns. Primary dimension."
        tests:
          - not_null
          # This multi-column test ensures the combination is unique
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - Target_Audience
                - dimension_value
                - dimension_type
          - relationships:
              to: ref('stg_campaigns')
              field: Company

      - name: Target_Audience
        description: "Specific audience segment targeted by the campaigns within the company. Secondary dimension."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Target_Audience

      - name: dimension_value
        description: "The specific value of the dimension being analyzed (e.g., a specific location, language, or campaign goal). Tertiary dimension value."
        tests:
          - not_null

      - name: dimension_type
        description: "Indicates the type of dimension represented by `dimension_value` ('location', 'language', 'goal'). Tertiary dimension type."
        tests:
          - not_null
          - accepted_values:
              values: ['location', 'language', 'goal']

      - name: campaign_count
        description: "Number of campaigns contributing to this specific combination in the current quarter."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: avg_conversion_rate
        description: "Average conversion rate for this combination in the current quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              where: "avg_conversion_rate IS NOT NULL" # Allow nulls if no campaigns, but value must be >= 0

      - name: avg_roi
        description: "Average Return on Investment (ROI) for this combination in the current quarter."
        # ROI can be negative, so no min_value test is strictly necessary unless specific business rules apply.

      - name: avg_acquisition_cost
        description: "Average cost to acquire a customer/lead for this combination in the current quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              where: "avg_acquisition_cost IS NOT NULL" # Allow nulls if no campaigns, but value must be >= 0

      - name: avg_ctr
        description: "Average Click-Through Rate (CTR) for this combination in the current quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1 # CTR is a percentage expressed as a decimal
              where: "avg_ctr IS NOT NULL" # Allow nulls if no impressions/clicks

      - name: company_avg_conversion_rate
        description: "Average conversion rate across all audiences and dimensions for this company in the current quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              where: "company_avg_conversion_rate IS NOT NULL"

      - name: company_avg_roi
        description: "Average ROI across all audiences and dimensions for this company in the current quarter."

      - name: company_avg_acquisition_cost
        description: "Average acquisition cost across all audiences and dimensions for this company in the current quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              where: "company_avg_acquisition_cost IS NOT NULL"

      - name: company_avg_ctr
        description: "Average CTR across all audiences and dimensions for this company in the current quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              where: "company_avg_ctr IS NOT NULL"

      - name: audience_avg_conversion_rate
        description: "Average conversion rate for this specific Company-Target_Audience pair across all dimensions in the current quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              where: "audience_avg_conversion_rate IS NOT NULL"

      - name: audience_avg_roi
        description: "Average ROI for this specific Company-Target_Audience pair across all dimensions in the current quarter."

      - name: audience_avg_acquisition_cost
        description: "Average acquisition cost for this specific Company-Target_Audience pair across all dimensions in the current quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              where: "audience_avg_acquisition_cost IS NOT NULL"

      - name: audience_avg_ctr
        description: "Average CTR for this specific Company-Target_Audience pair across all dimensions in the current quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              where: "audience_avg_ctr IS NOT NULL"

      - name: dimension_avg_conversion_rate
        description: "Average conversion rate for this specific Company-Dimension combination across all audiences in the current quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              where: "dimension_avg_conversion_rate IS NOT NULL"

      - name: dimension_avg_roi
        description: "Average ROI for this specific Company-Dimension combination across all audiences in the current quarter."

      - name: dimension_avg_acquisition_cost
        description: "Average acquisition cost for this specific Company-Dimension combination across all audiences in the current quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              where: "dimension_avg_acquisition_cost IS NOT NULL"

      - name: dimension_avg_ctr
        description: "Average CTR for this specific Company-Dimension combination across all audiences in the current quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              where: "dimension_avg_ctr IS NOT NULL"

      - name: global_avg_conversion_rate
        description: "Global average conversion rate across all combinations in the current quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              where: "global_avg_conversion_rate IS NOT NULL"

      - name: global_avg_roi
        description: "Global average ROI across all combinations in the current quarter."

      - name: global_avg_acquisition_cost
        description: "Global average acquisition cost across all combinations in the current quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              where: "global_avg_acquisition_cost IS NOT NULL"

      - name: global_avg_ctr
        description: "Global average CTR across all combinations in the current quarter."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              where: "global_avg_ctr IS NOT NULL"

      - name: conversion_rate_vs_company_avg
        description: "Percentage difference between the combination's conversion rate and the company's average conversion rate. ((avg_conv_rate / company_avg_conv_rate) - 1)"

      - name: roi_vs_company_avg
        description: "Percentage difference between the combination's ROI and the company's average ROI. ((avg_roi / company_avg_roi) - 1)"

      - name: acquisition_cost_vs_company_avg
        description: "Percentage difference showing how much lower the combination's acquisition cost is compared to the company average (inverted for positive = better). ((company_avg_acq_cost / avg_acq_cost) - 1)"

      - name: ctr_vs_company_avg
        description: "Percentage difference between the combination's CTR and the company's average CTR. ((avg_ctr / company_avg_ctr) - 1)"

      - name: conversion_rate_vs_audience_avg
        description: "Percentage difference between the combination's conversion rate and the average for its specific Company-Audience pair."

      - name: roi_vs_audience_avg
        description: "Percentage difference between the combination's ROI and the average for its specific Company-Audience pair."

      - name: acquisition_cost_vs_audience_avg
        description: "Percentage difference showing how much lower the combination's acquisition cost is compared to the average for its specific Company-Audience pair (inverted)."

      - name: ctr_vs_audience_avg
        description: "Percentage difference between the combination's CTR and the average for its specific Company-Audience pair."

      - name: conversion_rate_vs_dimension_avg
        description: "Percentage difference between the combination's conversion rate and the average for its specific Company-Dimension pair."

      - name: roi_vs_dimension_avg
        description: "Percentage difference between the combination's ROI and the average for its specific Company-Dimension pair."

      - name: acquisition_cost_vs_dimension_avg
        description: "Percentage difference showing how much lower the combination's acquisition cost is compared to the average for its specific Company-Dimension pair (inverted)."

      - name: ctr_vs_dimension_avg
        description: "Percentage difference between the combination's CTR and the average for its specific Company-Dimension pair."

      - name: conversion_rate_vs_global_avg
        description: "Percentage difference between the combination's conversion rate and the global average conversion rate."

      - name: roi_vs_global_avg
        description: "Percentage difference between the combination's ROI and the global average ROI."

      - name: acquisition_cost_vs_global_avg
        description: "Percentage difference showing how much lower the combination's acquisition cost is compared to the global average (inverted)."

      - name: ctr_vs_global_avg
        description: "Percentage difference between the combination's CTR and the global average CTR."

      - name: normalized_conversion_rate
        description: "Combination's average conversion rate normalized to a 0-1 scale across all combinations in the dataset."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              where: "normalized_conversion_rate IS NOT NULL"

      - name: normalized_roi
        description: "Combination's average ROI normalized to a 0-1 scale across all combinations in the dataset."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              where: "normalized_roi IS NOT NULL"

      - name: normalized_acquisition_cost
        description: "Combination's average acquisition cost normalized to a 0-1 scale (inverted, so 1 is best/lowest cost) across all combinations."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              where: "normalized_acquisition_cost IS NOT NULL"

      - name: normalized_ctr
        description: "Combination's average CTR normalized to a 0-1 scale across all combinations in the dataset."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              where: "normalized_ctr IS NOT NULL"

      - name: composite_score
        description: "Weighted score (0-1) combining normalized metrics to rank overall performance. Weights: ROI(40%), ConvRate(30%), AcqCost(20%), CTR(10%). Higher is better."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              where: "composite_score IS NOT NULL"

      - name: is_top_performer
        description: "Boolean flag indicating if this combination ranks in the top 10% based on the composite score within its dimension type (location, language, or goal)."
        tests:
          - not_null
          - accepted_values:
              values: [true, false]