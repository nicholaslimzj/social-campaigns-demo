version: 2

models:
  - name: channel_quarter_anomalies
    description: |
      Identifies anomalies in marketing channel performance metrics on a quarterly basis for each company.
      It calculates rolling statistics (mean, standard deviation) for key metrics (Conversion Rate, ROI, Acquisition Cost, Clicks, Impressions, CTR, Spend, Revenue, Campaign Count) over the previous 3 quarters.
      It then compares the current quarter's metrics against these historical benchmarks using Z-scores.
      Metrics with an absolute Z-score greater than 2 are flagged as anomalies.
      The model provides detailed statistics, Z-scores, anomaly flags for each metric, and summary indicators like `has_anomaly`, `anomaly_count`, and `anomaly_impact`.
      This model is intended for use in dashboards for anomaly alerting, performance monitoring, and risk management.
      Filters data to only include the most recent quarter available in the source data.
    config:
      materialized: table
      tags:
        - 'mart'
        - 'anomaly_detection'
        - 'performance'
        - 'marketing'
    columns:
      - name: Company
        description: "The name of the company being analyzed. Primary dimension."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Company # Assuming 'Company' exists and is validated in stg_campaigns

      - name: Channel_Used
        description: "The marketing channel used (e.g., Facebook, Instagram, Pinterest). Secondary dimension."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Channel_Used # Assuming 'Channel_Used' exists and is validated in stg_campaigns
          # Test for uniqueness across Company and Channel for the current quarter
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - Channel_Used

      - name: avg_conversion_rate
        description: "The average conversion rate for the company and channel during the current quarter."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: conversion_rate_mean
        description: "The rolling average conversion rate over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: conversion_rate_std
        description: "The rolling population standard deviation of the conversion rate over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE
          - dbt_expectations.expect_column_values_to_be_non_negative # Standard deviation cannot be negative

      - name: conversion_rate_z
        description: "The Z-score for the current quarter's average conversion rate, indicating deviation from the rolling mean in terms of standard deviations. Null if standard deviation is zero or null."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: conversion_rate_anomaly
        description: "Flag indicating if the conversion rate is an anomaly ('anomaly') or within expected range ('normal') based on an absolute Z-score threshold of 2."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: avg_roi
        description: "The average Return on Investment (ROI) for the company and channel during the current quarter."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: roi_mean
        description: "The rolling average ROI over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: roi_std
        description: "The rolling population standard deviation of the ROI over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: roi_z
        description: "The Z-score for the current quarter's average ROI. Null if standard deviation is zero or null."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: roi_anomaly
        description: "Flag indicating if the ROI is an anomaly ('anomaly') or 'normal' based on an absolute Z-score threshold of 2."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: avg_acquisition_cost
        description: "The average acquisition cost for the company and channel during the current quarter."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: acquisition_cost_mean
        description: "The rolling average acquisition cost over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: acquisition_cost_std
        description: "The rolling population standard deviation of the acquisition cost over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: acquisition_cost_z
        description: "The Z-score for the current quarter's average acquisition cost. Null if standard deviation is zero or null."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: acquisition_cost_anomaly
        description: "Flag indicating if the acquisition cost is an anomaly ('anomaly') or 'normal' based on an absolute Z-score threshold of 2."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: total_clicks
        description: "The total number of clicks for the company and channel during the current quarter."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: HUGEINT # Or BIGINT depending on exact DB type mapping
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: clicks_mean
        description: "The rolling average total clicks over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: clicks_std
        description: "The rolling population standard deviation of total clicks over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: clicks_z
        description: "The Z-score for the current quarter's total clicks. Null if standard deviation is zero or null."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: clicks_anomaly
        description: "Flag indicating if the total clicks count is an anomaly ('anomaly') or 'normal' based on an absolute Z-score threshold of 2."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: total_impressions
        description: "The total number of impressions for the company and channel during the current quarter."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: HUGEINT # Or BIGINT
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: impressions_mean
        description: "The rolling average total impressions over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: impressions_std
        description: "The rolling population standard deviation of total impressions over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: impressions_z
        description: "The Z-score for the current quarter's total impressions. Null if standard deviation is zero or null."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: impressions_anomaly
        description: "Flag indicating if the total impressions count is an anomaly ('anomaly') or 'normal' based on an absolute Z-score threshold of 2."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: quarterly_ctr
        description: "The calculated Click-Through Rate (CTR) for the company and channel during the current quarter (Total Clicks / Total Impressions)."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: FLOAT # Or DOUBLE depending on DB
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1
              strictly: false # Allow 0 and 1
              # Note: This test might fail if the column can be NULL (e.g., if impressions are 0)
              # Add `or_null: true` if nulls are acceptable.

      - name: ctr_mean
        description: "The rolling average CTR over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: ctr_std
        description: "The rolling population standard deviation of the CTR over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: ctr_z
        description: "The Z-score for the current quarter's CTR. Null if standard deviation is zero or null."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: ctr_anomaly
        description: "Flag indicating if the CTR is an anomaly ('anomaly') or 'normal' based on an absolute Z-score threshold of 2."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: total_spend
        description: "The total calculated spend for the company and channel during the current quarter."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: spend_mean
        description: "The rolling average total spend over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: spend_std
        description: "The rolling population standard deviation of total spend over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: spend_z
        description: "The Z-score for the current quarter's total spend. Null if standard deviation is zero or null."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: spend_anomaly
        description: "Flag indicating if the total spend is an anomaly ('anomaly') or 'normal' based on an absolute Z-score threshold of 2."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: total_revenue
        description: "The total calculated revenue for the company and channel during the current quarter."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE
          # Revenue can theoretically be negative if ROI < -1, but often constrained non-negative in practice.
          # - dbt_expectations.expect_column_values_to_be_non_negative

      - name: revenue_mean
        description: "The rolling average total revenue over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: revenue_std
        description: "The rolling population standard deviation of total revenue over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: revenue_z
        description: "The Z-score for the current quarter's total revenue. Null if standard deviation is zero or null."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: revenue_anomaly
        description: "Flag indicating if the total revenue is an anomaly ('anomaly') or 'normal' based on an absolute Z-score threshold of 2."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: campaign_count
        description: "The count of distinct campaigns run by the company on the channel during the current quarter."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: BIGINT
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: campaign_count_mean
        description: "The rolling average campaign count over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: campaign_count_std
        description: "The rolling population standard deviation of the campaign count over the previous 3 quarters for this company and channel."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: campaign_count_z
        description: "The Z-score for the current quarter's campaign count. Null if standard deviation is zero or null."
        tests:
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: DOUBLE

      - name: campaign_count_anomaly
        description: "Flag indicating if the campaign count is an anomaly ('anomaly') or 'normal' based on an absolute Z-score threshold of 2."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: has_anomaly
        description: "A boolean flag indicating if at least one metric for this company/channel combination in the current quarter was flagged as an anomaly (TRUE) or if all metrics were normal (FALSE)."
        tests:
          - not_null
          - accepted_values: # For boolean types
              values: [true, false]

      - name: anomaly_count
        description: "The total number of metrics flagged as anomalies for this company/channel combination in the current quarter. Provides a measure of anomaly severity."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_of_type:
              column_type: INTEGER
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: anomaly_impact
        description: "A categorical assessment ('positive', 'negative', 'normal') of the overall impact of the detected anomalies. 'positive' indicates anomalies generally favorable to business goals (e.g., high ROI, high Revenue, low Cost), 'negative' indicates unfavorable anomalies. 'normal' if no significant anomalies impacting overall performance direction are detected."
        tests:
          - not_null
          - accepted_values:
              values: ['positive', 'negative', 'normal']