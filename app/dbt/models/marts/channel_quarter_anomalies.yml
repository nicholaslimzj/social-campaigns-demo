version: 2

models:
  - name: channel_quarter_anomalies
    description: "Identifies anomalies in marketing channel performance on a quarterly basis. Compares key metrics (Conversion Rate, ROI, Acquisition Cost, Clicks, Impressions, CTR, Spend, Revenue) for the latest quarter against a rolling 3-quarter average using z-score methodology. Flags significant deviations (>2 standard deviations) to highlight potential issues or successes. Designed for performance monitoring and risk management dashboards."
    config:
      materialized: table
      tags: ['mart', 'marketing', 'anomaly_detection', 'performance']
    columns:
      - name: Channel_Used
        description: "The marketing channel being analyzed (e.g., Facebook, Instagram, Google Ads)."
        tests:
          - not_null
          # Test for the unique combination of channel and quarter
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Channel_Used
                - quarter
          # Optional: Test relationship if stg_campaigns has a distinct list of channels
          # - relationships:
          #     to: ref('stg_campaigns') # Assuming stg_campaigns has a unique channel column
          #     field: Channel_Used # The corresponding column name in stg_campaigns

      - name: quarter
        description: "A numerical representation of the year and quarter (calculated as YYYY * 4 + CEIL(Month / 3)). Represents the time period for the aggregated metrics."
        tests:
          - not_null

      - name: avg_conversion_rate
        description: "The average conversion rate for the channel during the specified quarter."
        # Not adding not_null as it could be null if no conversions/clicks occurred.

      - name: conversion_rate_mean
        description: "The rolling average of the conversion rate over the previous 3 quarters for the channel. Used as the expected value."
        # Can be null for initial quarters

      - name: conversion_rate_std
        description: "The rolling standard deviation of the conversion rate over the previous 3 quarters for the channel. Used to measure variability."
        # Can be null or zero for initial quarters or stable periods

      - name: conversion_rate_z
        description: "The z-score for conversion rate in the quarter, calculated as (value - rolling_mean) / rolling_std. Measures deviation from the recent average in terms of standard deviations."
        # Can be null if std is null or zero

      - name: conversion_rate_anomaly
        description: "Flag indicating if the conversion rate for the quarter is considered an anomaly ('anomaly' if |z-score| > 2, 'normal' otherwise)."
        tests:
          - not_null
          - accepted_values:
              values: ['normal', 'anomaly']

      - name: avg_roi
        description: "The average Return on Investment (ROI) for the channel during the specified quarter."

      - name: roi_mean
        description: "The rolling average of the ROI over the previous 3 quarters for the channel."

      - name: roi_std
        description: "The rolling standard deviation of the ROI over the previous 3 quarters for the channel."

      - name: roi_z
        description: "The z-score for ROI in the quarter."

      - name: roi_anomaly
        description: "Flag indicating if the ROI for the quarter is considered an anomaly."
        tests:
          - not_null
          - accepted_values:
              values: ['normal', 'anomaly']

      - name: avg_acquisition_cost
        description: "The average acquisition cost for the channel during the specified quarter."

      - name: acquisition_cost_mean
        description: "The rolling average of the acquisition cost over the previous 3 quarters for the channel."

      - name: acquisition_cost_std
        description: "The rolling standard deviation of the acquisition cost over the previous 3 quarters for the channel."

      - name: acquisition_cost_z
        description: "The z-score for acquisition cost in the quarter."

      - name: acquisition_cost_anomaly
        description: "Flag indicating if the acquisition cost for the quarter is considered an anomaly."
        tests:
          - not_null
          - accepted_values:
              values: ['normal', 'anomaly']

      - name: total_clicks
        description: "The total number of clicks generated by the channel during the specified quarter."
        tests:
          - not_null # Aggregated counts should generally not be null

      - name: clicks_mean
        description: "The rolling average of total clicks over the previous 3 quarters for the channel."

      - name: clicks_std
        description: "The rolling standard deviation of total clicks over the previous 3 quarters for the channel."

      - name: clicks_z
        description: "The z-score for total clicks in the quarter."

      - name: clicks_anomaly
        description: "Flag indicating if the total clicks for the quarter is considered an anomaly."
        tests:
          - not_null
          - accepted_values:
              values: ['normal', 'anomaly']

      - name: total_impressions
        description: "The total number of impressions generated by the channel during the specified quarter."
        tests:
          - not_null

      - name: impressions_mean
        description: "The rolling average of total impressions over the previous 3 quarters for the channel."

      - name: impressions_std
        description: "The rolling standard deviation of total impressions over the previous 3 quarters for the channel."

      - name: impressions_z
        description: "The z-score for total impressions in the quarter."

      - name: impressions_anomaly
        description: "Flag indicating if the total impressions for the quarter is considered an anomaly."
        tests:
          - not_null
          - accepted_values:
              values: ['normal', 'anomaly']

      - name: quarterly_ctr
        description: "The calculated Click-Through Rate (CTR) for the channel during the specified quarter (Total Clicks / Total Impressions)."

      - name: ctr_mean
        description: "The rolling average of the quarterly CTR over the previous 3 quarters for the channel."

      - name: ctr_std
        description: "The rolling standard deviation of the quarterly CTR over the previous 3 quarters for the channel."

      - name: ctr_z
        description: "The z-score for quarterly CTR in the quarter."

      - name: ctr_anomaly
        description: "Flag indicating if the quarterly CTR for the quarter is considered an anomaly."
        tests:
          - not_null
          - accepted_values:
              values: ['normal', 'anomaly']

      - name: total_spend
        description: "The total calculated spend for the channel during the specified quarter (SUM of Clicks * Acquisition_Cost)."
        tests:
          - not_null

      - name: spend_mean
        description: "The rolling average of total spend over the previous 3 quarters for the channel."

      - name: spend_std
        description: "The rolling standard deviation of total spend over the previous 3 quarters for the channel."

      - name: spend_z
        description: "The z-score for total spend in the quarter."

      - name: spend_anomaly
        description: "Flag indicating if the total spend for the quarter is considered an anomaly."
        tests:
          - not_null
          - accepted_values:
              values: ['normal', 'anomaly']

      - name: total_revenue
        description: "The total calculated revenue for the channel during the specified quarter (SUM of Clicks * Acquisition_Cost * ROI)."
        tests:
          - not_null

      - name: revenue_mean
        description: "The rolling average of total revenue over the previous 3 quarters for the channel."

      - name: revenue_std
        description: "The rolling standard deviation of total revenue over the previous 3 quarters for the channel."

      - name: revenue_z
        description: "The z-score for total revenue in the quarter."

      - name: revenue_anomaly
        description: "Flag indicating if the total revenue for the quarter is considered an anomaly."
        tests:
          - not_null
          - accepted_values:
              values: ['normal', 'anomaly']

      - name: has_anomaly
        description: "Boolean flag (TRUE/FALSE) indicating if *any* metric for this channel and quarter was flagged as an anomaly."
        tests:
          - not_null

      - name: anomaly_count
        description: "The total number of individual metrics flagged as anomalies for this channel and quarter."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              # Max value is the number of metrics checked for anomalies (8 in this case)
              max_value: 8

      - name: anomaly_impact
        description: "Overall assessment of the anomaly's direction ('positive' if driven by favorable deviations, 'negative' if driven by unfavorable deviations, 'normal' if no significant anomalies)."
        tests:
          - not_null
          - accepted_values:
              values: ['positive', 'negative', 'normal']