version: 2

models:
  - name: campaign_duration_analysis
    description: |
      Analyzes the relationship between campaign duration and performance metrics (ROI, Conversion Rate, CTR, etc.).
      It identifies optimal campaign durations overall and for specific combinations of goals, segments, and channels based on maximizing ROI.
      The model provides three types of analysis outputs distinguished by the 'analysis_type' column:
      1. 'optimal_durations': Recommends the best duration bucket for different dimensions.
      2. 'exact_duration_performance': Shows average performance metrics for each exact campaign duration (in days) for trend analysis.
      3. 'roi_impact_analysis': Compares the actual ROI of campaigns within specific goal/segment/channel/duration groups against the potential ROI if the optimal duration had been used.
      This mart model aggregates data from stg_campaigns and uses statistical summaries to derive insights without external ML libraries.
    config:
      materialized: table
      tags: ['mart', 'campaigns', 'performance', 'optimization', 'duration', 'roi']
    columns:
      - name: analysis_type
        description: "Type of analysis presented in the row: 'optimal_durations', 'exact_duration_performance', or 'roi_impact_analysis'."
        tests:
          - not_null
          - accepted_values:
              values: ['optimal_durations', 'exact_duration_performance', 'roi_impact_analysis']

      - name: dimension
        description: "The dimension for which the optimal duration is calculated (e.g., 'Overall', 'Goal', 'Segment', 'Channel', 'Goal-Segment', 'Goal-Channel'). Populated only when analysis_type = 'optimal_durations'."

      - name: category
        description: "The specific category within the dimension (e.g., 'All', 'Product Launch', 'High Value', 'Email', 'Product Launch - High Value'). Populated only when analysis_type = 'optimal_durations'."

      - name: optimal_duration_bucket
        description: "The duration range identified as having the highest average ROI for the given dimension and category (e.g., '15-21 days'). Populated only when analysis_type = 'optimal_durations'."
        tests:
          - accepted_values: # Based on the CASE statement in the SQL
              values: ['1-7 days', '8-14 days', '15-21 days', '22-30 days', '31-45 days', '46-60 days', '60+ days']
              config:
                severity: warn # Allow NULLs for other analysis types

      - name: optimal_min_duration
        description: "The minimum duration (in days) included in the optimal duration bucket. Populated only when analysis_type = 'optimal_durations'."
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 1
              config:
                severity: warn # Allow NULLs

      - name: optimal_max_duration
        description: "The maximum duration (in days) included in the optimal duration bucket. Populated only when analysis_type = 'optimal_durations'."
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 1
              config:
                severity: warn # Allow NULLs

      - name: optimal_roi
        description: "The average Return on Investment (ROI) achieved within the optimal duration bucket for the given dimension/category. Populated only when analysis_type = 'optimal_durations'."

      - name: optimal_conversion_rate
        description: "The average Conversion Rate achieved within the optimal duration bucket for the given dimension/category. Populated only when analysis_type = 'optimal_durations'."
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1 # Assuming conversion rate is between 0 and 1
              config:
                severity: warn # Allow NULLs

      - name: optimal_roi_per_day
        description: "The average ROI per day achieved within the optimal duration bucket, normalizing ROI by duration length. Populated only when analysis_type = 'optimal_durations'."

      - name: optimal_duration_range
        description: "A formatted string representing the optimal duration range (e.g., '15-21 days'). Derived from optimal_min_duration and optimal_max_duration. Populated only when analysis_type = 'optimal_durations'."

      - name: Duration
        description: "The exact campaign duration in days. Populated only when analysis_type = 'exact_duration_performance'."
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 1
              config:
                severity: warn # Allow NULLs

      - name: campaign_count
        description: "The number of campaigns aggregated in this row. Represents campaigns within a duration bucket/dimension (for optimal_durations), campaigns with an exact duration (for exact_duration_performance), or campaigns within a specific goal/segment/channel/duration group (for roi_impact_analysis). Note: Aggregations typically require >= 3 campaigns based on HAVING clauses."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 1 # Should be >= 3 for aggregated rows based on SQL logic, but allow 1 for edge cases.

      - name: avg_conversion_rate
        description: "Average conversion rate for campaigns with the specific 'Duration'. Populated only when analysis_type = 'exact_duration_performance'."
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1 # Assuming conversion rate is between 0 and 1
              config:
                severity: warn # Allow NULLs

      - name: avg_roi
        description: "Average ROI for campaigns with the specific 'Duration'. Populated only when analysis_type = 'exact_duration_performance'."

      - name: avg_acquisition_cost
        description: "Average Acquisition Cost for campaigns with the specific 'Duration'. Populated only when analysis_type = 'exact_duration_performance'."
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              config:
                severity: warn # Allow NULLs

      - name: avg_ctr
        description: "Average Click-Through Rate (CTR) for campaigns with the specific 'Duration'. Populated only when analysis_type = 'exact_duration_performance'."
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              # Max value can theoretically exceed 1 if clicks > impressions (unlikely but possible with data issues)
              config:
                severity: warn # Allow NULLs

      - name: avg_roi_per_day
        description: "Average ROI per day for campaigns with the specific 'Duration'. Populated only when analysis_type = 'exact_duration_performance'."

      - name: goal
        description: "The campaign goal associated with the ROI impact analysis. Populated only when analysis_type = 'roi_impact_analysis'."
        tests:
          - relationships:
              to: ref('stg_campaigns')
              field: Campaign_Goal
              config:
                severity: warn # Allow NULLs for other analysis types

      - name: segment
        description: "The customer segment associated with the ROI impact analysis. Populated only when analysis_type = 'roi_impact_analysis'."
        tests:
          - relationships:
              to: ref('stg_campaigns')
              field: Customer_Segment
              config:
                severity: warn # Allow NULLs for other analysis types

      - name: channel
        description: "The marketing channel associated with the ROI impact analysis. Populated only when analysis_type = 'roi_impact_analysis'."
        tests:
          - relationships:
              to: ref('stg_campaigns')
              field: Channel_Used
              config:
                severity: warn # Allow NULLs for other analysis types

      - name: duration_bucket
        description: "The duration bucket that the campaigns fell into for this specific goal/segment/channel combination. Populated only when analysis_type = 'roi_impact_analysis'."
        tests:
          - accepted_values: # Based on the CASE statement in the SQL
              values: ['1-7 days', '8-14 days', '15-21 days', '22-30 days', '31-45 days', '46-60 days', '60+ days']
              config:
                severity: warn # Allow NULLs for other analysis types

      - name: optimal_bucket_for_goal_segment
        description: "The optimal duration bucket identified specifically for this goal-segment combination. Populated only when analysis_type = 'roi_impact_analysis'."

      - name: optimal_bucket_for_goal_channel
        description: "The optimal duration bucket identified specifically for this goal-channel combination. Populated only when analysis_type = 'roi_impact_analysis'."

      - name: actual_roi
        description: "The actual average ROI achieved by campaigns in this specific goal/segment/channel/duration_bucket group. Populated only when analysis_type = 'roi_impact_analysis'."

      - name: optimal_roi_for_goal_segment
        description: "The optimal ROI identified for this specific goal-segment combination (from the 'optimal_durations' analysis). Populated only when analysis_type = 'roi_impact_analysis'."

      - name: optimal_roi_for_goal_channel
        description: "The optimal ROI identified for this specific goal-channel combination (from the 'optimal_durations' analysis). Populated only when analysis_type = 'roi_impact_analysis'."

      - name: potential_roi_improvement_goal_segment
        description: "The difference between the optimal ROI (for goal-segment) and the actual ROI achieved. Represents potential uplift. Populated only when analysis_type = 'roi_impact_analysis'."

      - name: potential_roi_improvement_goal_channel
        description: "The difference between the optimal ROI (for goal-channel) and the actual ROI achieved. Represents potential uplift. Populated only when analysis_type = 'roi_impact_analysis'."

      - name: pct_improvement_goal_segment
        description: "The potential percentage ROI improvement if the optimal duration bucket for the goal-segment combination had been used. Populated only when analysis_type = 'roi_impact_analysis'."

      - name: pct_improvement_goal_channel
        description: "The potential percentage ROI improvement if the optimal duration bucket for the goal-channel combination had been used. Populated only when analysis_type = 'roi_impact_analysis'."

      - name: is_using_optimal_duration_goal_segment
        description: "Boolean flag indicating TRUE if the 'duration_bucket' for this group matches the 'optimal_bucket_for_goal_segment'. Populated only when analysis_type = 'roi_impact_analysis'."
        tests:
          - accepted_values:
              values: [True, False]
              config:
                severity: warn # Allow NULLs

      - name: is_using_optimal_duration_goal_channel
        description: "Boolean flag indicating TRUE if the 'duration_bucket' for this group matches the 'optimal_bucket_for_goal_channel'. Populated only when analysis_type = 'roi_impact_analysis'."
        tests:
          - accepted_values:
              values: [True, False]
              config:
                severity: warn # Allow NULLs