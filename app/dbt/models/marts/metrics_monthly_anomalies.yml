version: 2

models:
  - name: metrics_monthly_anomalies
    description: |
      Identifies anomalies in monthly performance metrics for each company by analyzing deviations from expected values based on recent trends (rolling 3-month window).
      It calculates rolling statistics (mean, standard deviation) for key metrics, computes z-scores to measure deviation, and flags significant outliers (absolute z-score > 2) that may require investigation.
      This model aggregates data from `stg_campaigns` to a monthly level per company before performing the anomaly detection.
      Used in dashboards for Monthly Anomaly Detection alerts, Performance Monitoring, and Risk Management visualizations.
    config:
      materialized: table
      tags:
        - 'mart'
        - 'anomaly_detection'
        - 'performance'
        - 'monthly'
    columns:
      - name: Company
        description: "Identifier for the company whose metrics are being analyzed."
        tests:
          - not_null
          # Apply the unique combination test on one of the key columns
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - month
          # Optional: Add relationship test if a dim_companies model exists
          # - relationships:
          #     to: ref('dim_companies')
          #     field: company_name # Assuming dim_companies has a company_name field

      - name: month
        description: "The numeric representation of the month (1-12) for which the metrics and anomalies are calculated."
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

      - name: avg_conversion_rate
        description: "The average conversion rate for the company during the specified month."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              # max_value: 1 # Or higher if applicable, depending on definition

      - name: conversion_rate_mean
        description: "The rolling average conversion rate over the 3 months preceding the current month for the company. Used as the expected value for anomaly detection. Can be NULL for early months."
        # No specific tests needed, can be NULL

      - name: conversion_rate_std
        description: "The rolling population standard deviation of the conversion rate over the 3 months preceding the current month for the company. Measures historical volatility. Can be NULL or 0 for early months or stable periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: conversion_rate_z
        description: "The z-score for the monthly average conversion rate, indicating how many standard deviations the current month's value is from the rolling 3-month mean. NULL if standard deviation is 0 or undefined."
        # No specific tests needed, can be NULL

      - name: conversion_rate_anomaly
        description: "Flag indicating if the monthly average conversion rate is considered an anomaly ('anomaly') or within the expected range ('normal') based on the z-score threshold (>|2|)."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: avg_roi
        description: "The average Return on Investment (ROI) for the company during the specified month."
        tests:
          - not_null # ROI can be negative

      - name: roi_mean
        description: "The rolling average ROI over the 3 months preceding the current month for the company. Used as the expected value for anomaly detection. Can be NULL for early months."
        # No specific tests needed, can be NULL

      - name: roi_std
        description: "The rolling population standard deviation of the ROI over the 3 months preceding the current month for the company. Measures historical volatility. Can be NULL or 0 for early months or stable periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: roi_z
        description: "The z-score for the monthly average ROI, indicating how many standard deviations the current month's value is from the rolling 3-month mean. NULL if standard deviation is 0 or undefined."
        # No specific tests needed, can be NULL

      - name: roi_anomaly
        description: "Flag indicating if the monthly average ROI is considered an anomaly ('anomaly') or within the expected range ('normal') based on the z-score threshold (>|2|)."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: avg_acquisition_cost
        description: "The average Acquisition Cost for the company during the specified month."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: acquisition_cost_mean
        description: "The rolling average Acquisition Cost over the 3 months preceding the current month for the company. Used as the expected value for anomaly detection. Can be NULL for early months."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative:
              allow_nulls: true # Mean can be null if preceding data is missing

      - name: acquisition_cost_std
        description: "The rolling population standard deviation of the Acquisition Cost over the 3 months preceding the current month for the company. Measures historical volatility. Can be NULL or 0 for early months or stable periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: acquisition_cost_z
        description: "The z-score for the monthly average Acquisition Cost, indicating how many standard deviations the current month's value is from the rolling 3-month mean. NULL if standard deviation is 0 or undefined."
        # No specific tests needed, can be NULL

      - name: acquisition_cost_anomaly
        description: "Flag indicating if the monthly average Acquisition Cost is considered an anomaly ('anomaly') or within the expected range ('normal') based on the z-score threshold (>|2|)."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: total_clicks
        description: "The total number of clicks for the company during the specified month."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: clicks_mean
        description: "The rolling average total clicks over the 3 months preceding the current month for the company. Used as the expected value for anomaly detection. Can be NULL for early months."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative:
              allow_nulls: true

      - name: clicks_std
        description: "The rolling population standard deviation of the total clicks over the 3 months preceding the current month for the company. Measures historical volatility. Can be NULL or 0 for early months or stable periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: clicks_z
        description: "The z-score for the total monthly clicks, indicating how many standard deviations the current month's value is from the rolling 3-month mean. NULL if standard deviation is 0 or undefined."
        # No specific tests needed, can be NULL

      - name: clicks_anomaly
        description: "Flag indicating if the total monthly clicks is considered an anomaly ('anomaly') or within the expected range ('normal') based on the z-score threshold (>|2|)."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: total_impressions
        description: "The total number of impressions for the company during the specified month."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: impressions_mean
        description: "The rolling average total impressions over the 3 months preceding the current month for the company. Used as the expected value for anomaly detection. Can be NULL for early months."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative:
              allow_nulls: true

      - name: impressions_std
        description: "The rolling population standard deviation of the total impressions over the 3 months preceding the current month for the company. Measures historical volatility. Can be NULL or 0 for early months or stable periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: impressions_z
        description: "The z-score for the total monthly impressions, indicating how many standard deviations the current month's value is from the rolling 3-month mean. NULL if standard deviation is 0 or undefined."
        # No specific tests needed, can be NULL

      - name: impressions_anomaly
        description: "Flag indicating if the total monthly impressions is considered an anomaly ('anomaly') or within the expected range ('normal') based on the z-score threshold (>|2|)."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: monthly_ctr
        description: "The calculated Click-Through Rate (CTR) for the company during the specified month (Total Clicks / Total Impressions)."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              # max_value: 1 # CTR is typically between 0 and 1

      - name: ctr_mean
        description: "The rolling average CTR over the 3 months preceding the current month for the company. Used as the expected value for anomaly detection. Can be NULL for early months."
        # No specific tests needed, can be NULL

      - name: ctr_std
        description: "The rolling population standard deviation of the CTR over the 3 months preceding the current month for the company. Measures historical volatility. Can be NULL or 0 for early months or stable periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: ctr_z
        description: "The z-score for the monthly CTR, indicating how many standard deviations the current month's value is from the rolling 3-month mean. NULL if standard deviation is 0 or undefined."
        # No specific tests needed, can be NULL

      - name: ctr_anomaly
        description: "Flag indicating if the monthly CTR is considered an anomaly ('anomaly') or within the expected range ('normal') based on the z-score threshold (>|2|)."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: total_spend
        description: "The total calculated spend for the company during the specified month."
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: spend_mean
        description: "The rolling average total spend over the 3 months preceding the current month for the company. Used as the expected value for anomaly detection. Can be NULL for early months."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative:
              allow_nulls: true

      - name: spend_std
        description: "The rolling population standard deviation of the total spend over the 3 months preceding the current month for the company. Measures historical volatility. Can be NULL or 0 for early months or stable periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: spend_z
        description: "The z-score for the total monthly spend, indicating how many standard deviations the current month's value is from the rolling 3-month mean. NULL if standard deviation is 0 or undefined."
        # No specific tests needed, can be NULL

      - name: spend_anomaly
        description: "Flag indicating if the total monthly spend is considered an anomaly ('anomaly') or within the expected range ('normal') based on the z-score threshold (>|2|)."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: total_revenue
        description: "The total calculated revenue for the company during the specified month."
        tests:
          - not_null
          # Revenue can theoretically be negative if costs exceed gross profit in some models, adjust if needed.
          # - dbt_expectations.expect_column_values_to_be_non_negative

      - name: revenue_mean
        description: "The rolling average total revenue over the 3 months preceding the current month for the company. Used as the expected value for anomaly detection. Can be NULL for early months."
        # No specific tests needed, can be NULL

      - name: revenue_std
        description: "The rolling population standard deviation of the total revenue over the 3 months preceding the current month for the company. Measures historical volatility. Can be NULL or 0 for early months or stable periods."
        tests:
          - dbt_expectations.expect_column_values_to_be_non_negative

      - name: revenue_z
        description: "The z-score for the total monthly revenue, indicating how many standard deviations the current month's value is from the rolling 3-month mean. NULL if standard deviation is 0 or undefined."
        # No specific tests needed, can be NULL

      - name: revenue_anomaly
        description: "Flag indicating if the total monthly revenue is considered an anomaly ('anomaly') or within the expected range ('normal') based on the z-score threshold (>|2|)."
        tests:
          - not_null
          - accepted_values:
              values: ['anomaly', 'normal']

      - name: has_anomaly
        description: "A boolean flag that is TRUE if any of the calculated metrics for the company and month were flagged as an anomaly, FALSE otherwise. Useful for filtering."
        tests:
          - not_null