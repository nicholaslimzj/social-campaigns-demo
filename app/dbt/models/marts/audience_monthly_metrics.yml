version: 2

models:
  - name: audience_monthly_metrics
    description: "Aggregates campaign performance metrics monthly by company and target audience. Provides insights into audience-specific trends, month-over-month changes, spend, revenue, and efficiency over time. Designed for dashboarding audience ROI and performance trends."
    config:
      materialized: table
      tags: ['mart', 'marketing', 'performance', 'monthly', 'audience']

    columns:
      - name: Company
        description: "The name of the company associated with the campaign data. Primary dimension for aggregation."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Company
          # Apply the multi-column uniqueness test to one of the key columns
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - Target_Audience
                - month

      - name: Target_Audience
        description: "The specific audience segment targeted by the campaigns. Secondary dimension for aggregation."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Target_Audience

      - name: month
        description: "The calendar month (1-12) extracted from the campaign date, used for monthly aggregation."
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

      - name: campaign_count
        description: "The total number of campaigns run for the specific company, target audience, and month."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: avg_conversion_rate
        description: "The average conversion rate across all campaigns for the specific company, target audience, and month. Calculated as the average of individual campaign Conversion_Rate values."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0  # Conversion rate cannot be negative

      - name: avg_roi
        description: "The average Return on Investment (ROI) across all campaigns for the specific company, target audience, and month. Calculated as the average of individual campaign ROI values."
        # ROI can theoretically be negative if costs exceed revenue significantly
        # No specific range test applied, but not_null could be considered if NULLs are unexpected post-aggregation

      - name: avg_acquisition_cost
        description: "The average cost to acquire a customer (Acquisition Cost) across all campaigns for the specific company, target audience, and month. Calculated as the average of individual campaign Acquisition_Cost values."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0 # Acquisition cost should not be negative

      - name: monthly_ctr
        description: "The overall Click-Through Rate (CTR) for the specific company, target audience, and month. Calculated as SUM(Clicks) / SUM(Impressions)."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              # max_value: 1 # CTR is typically <= 1, but edge cases/bad data might exceed it. Optional.

      - name: total_clicks
        description: "The total number of clicks accumulated across all campaigns for the specific company, target audience, and month."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: total_impressions
        description: "The total number of impressions accumulated across all campaigns for the specific company, target audience, and month."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: total_spend
        description: "The estimated total spend for the specific company, target audience, and month. Calculated as SUM(Clicks * Acquisition_Cost)."
        tests:
          - not_null # Assuming spend is always calculated, even if 0
          - dbt_utils.accepted_range:
              min_value: 0

      - name: total_revenue
        description: "The estimated total revenue generated for the specific company, target audience, and month. Calculated as SUM(Clicks * Acquisition_Cost * ROI)."
        # Revenue can be negative if ROI is negative
        # No specific range test applied, but not_null could be considered

      - name: roi_vs_prev_month
        description: "The percentage change in average ROI compared to the previous month for the same company and target audience. NULL for the earliest month in the data."
        # Can be NULL, positive, or negative. No standard range/value tests apply.

      - name: conversion_rate_vs_prev_month
        description: "The percentage change in average conversion rate compared to the previous month for the same company and target audience. NULL for the earliest month in the data."
        # Can be NULL, positive, or negative. No standard range/value tests apply.

      - name: acquisition_cost_vs_prev_month
        description: "The percentage change in average acquisition cost compared to the previous month for the same company and target audience (positive value indicates improvement/lower cost). NULL for the earliest month in the data."
        # Can be NULL, positive, or negative. No standard range/value tests apply.

      - name: ctr_vs_prev_month
        description: "The percentage change in monthly CTR compared to the previous month for the same company and target audience. NULL for the earliest month in the data."
        # Can be NULL, positive, or negative. No standard range/value tests apply.

      - name: audience_count
        description: "The total number of distinct target audiences active within the specific company during that month."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1 # There should be at least one audience (the current row's audience)

      - name: audience_share_clicks
        description: "The proportion of total clicks within the company for that month that came from this specific target audience. Calculated as SUM(Clicks for this Audience) / SUM(Total Clicks for Company)."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1 # Share must be between 0 and 1

      - name: response_rate
        description: "The rate at which impressions turned into clicks for this company, audience, and month. Calculated as total_clicks / total_impressions."
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              # max_value: 1 # Typically <= 1. Optional.

      - name: efficiency_ratio
        description: "A measure of efficiency, calculated as total_revenue / total_spend for this company, audience, and month. Represents revenue generated per dollar spent (similar to ROAS)."
        # Can be negative if revenue is negative. Can be NULL if spend is 0.
        # No standard range/value tests apply.