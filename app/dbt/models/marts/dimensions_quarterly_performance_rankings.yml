version: 2

models:
  - name: dimensions_quarterly_performance_rankings
    description: "Ranks entities (companies, channels, customer segments) within their respective dimensions based on key performance metrics (Conversion Rate, ROI, Acquisition Cost, CTR) for the most recent quarter. Includes quarter-over-quarter (QoQ) comparison against the previous quarter, calculating percentage changes and identifying performance trends (improved, declined, unchanged). Designed for performance ranking dashboards and QoQ analysis."
    config:
      materialized: table
      tags: ['mart', 'performance', 'ranking', 'quarterly']
    columns:
      - name: dimension
        description: "The category or dimension being analyzed (e.g., 'company', 'channel', 'segment'). This defines the group within which entities are ranked."
        tests:
          - not_null
          - accepted_values:
              values: ['company', 'channel', 'segment']
          # Test for multi-column uniqueness (primary key)
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - dimension
                - entity
                - metric

      - name: entity
        description: "The specific item within the dimension being ranked (e.g., a specific company name, channel name like 'Instagram', or customer segment name)."
        tests:
          - not_null
          # Relationship test is complex here as 'entity' maps to different columns in stg_campaigns based on 'dimension'.
          # A simple relationship test isn't feasible. Business logic ensures these entities exist in stg_campaigns.

      - name: metric
        description: "The specific performance metric being measured for the entity (e.g., 'conversion_rate', 'roi', 'acquisition_cost', 'ctr')."
        tests:
          - not_null
          - accepted_values:
              values: ['conversion_rate', 'roi', 'acquisition_cost', 'ctr']

      - name: metric_value
        description: "The calculated value of the specified metric for the entity in the current quarter (e.g., average conversion rate, average ROI)."
        tests:
          - not_null # Aggregated values should generally not be null unless the underlying group is empty, which is unlikely here.

      - name: metric_rank
        description: "The rank of the entity within its dimension for the specified metric in the current quarter (1 = best performance). Note: Lower rank (closer to 1) is better for 'acquisition_cost', while higher rank is better for others."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1 # Rank must be at least 1

      - name: total_entities
        description: "The total number of unique entities within the dimension for which the ranking is calculated in the current quarter."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1 # There must be at least one entity per dimension

      - name: campaign_count
        description: "The number of campaigns associated with this entity that contributed to the metrics in the current quarter."
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1 # An entity must have at least one campaign to be included in aggregations

      - name: prev_metric_value
        description: "The calculated value of the specified metric for the entity in the *previous* quarter. NULL if the entity had no data in the previous quarter."
        # No not_null test, as this can legitimately be NULL.

      - name: metric_qoq_change
        description: "The percentage change in the metric value from the previous quarter to the current quarter ((current - previous) / previous). For Acquisition Cost, the calculation reflects improvement: ((previous - current) / previous). NULL if previous quarter data is unavailable."
        # No not_null test, as this can legitimately be NULL.

      - name: trend
        description: "Indicates the performance trend based on the QoQ change: 'improved', 'declined', 'unchanged', or 'no_previous_data'. 'Improved' means higher Conversion Rate/ROI/CTR or lower Acquisition Cost."
        tests:
          - not_null
          - accepted_values:
              values: ['improved', 'declined', 'unchanged', 'no_previous_data']

      - name: current_window_start_month
        description: "The starting month number (1-12) of the current quarter analysis window."
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

      - name: current_window_end_month
        description: "The ending month number (1-12) of the current quarter analysis window."
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

      - name: previous_window_start_month
        description: "The starting month number (1-12) of the previous quarter analysis window."
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12] # Assuming valid month calculation

      - name: previous_window_end_month
        description: "The ending month number (1-12) of the previous quarter analysis window."
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12] # Assuming valid month calculation