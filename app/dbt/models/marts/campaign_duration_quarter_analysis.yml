version: 2

models:
  - name: campaign_duration_quarter_analysis
    description: |
      Analyzes the relationship between campaign duration and performance metrics (ROI, Conversion Rate, CTR, etc.) for the most recent quarter (last 3 months of data).
      It identifies optimal campaign duration buckets based on average ROI across different dimensions: overall company, company-goal, and company-channel.
      The model also provides aggregated performance metrics for exact campaign durations.
      This analysis helps in understanding optimal campaign lengths for planning and optimization.
      Data is filtered to include only duration buckets or exact durations with at least 2 campaigns.
      Output includes two types of analysis identified by the 'analysis_type' column: 'optimal_durations' and 'exact_duration_performance'.
    config:
      materialized: table
      tags:
        - 'mart'
        - 'marketing'
        - 'campaign_analysis'
        - 'performance'
        - 'optimization'
    columns:
      - name: analysis_type
        description: "Indicates the type of analysis presented in the row: 'optimal_durations' (summary of best performing duration bucket) or 'exact_duration_performance' (performance metrics for a specific campaign duration in days)."
        data_type: VARCHAR
        tests:
          - not_null
          - accepted_values:
              values: ['optimal_durations', 'exact_duration_performance']
        # Define the multi-column unique key here, anchored to analysis_type
        # This combination ensures uniqueness across both parts of the UNION ALL
        # Note: NULLs in dimension, category, Duration might affect standard unique tests depending on warehouse.
        # dbt_utils handles NULLs appropriately in this test.
        tests:
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - analysis_type
                - Company
                - dimension
                - category
                - Duration

      - name: Company
        description: "The name of the company for which the campaign analysis is performed."
        data_type: VARCHAR
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Company # Assuming 'Company' exists in stg_campaigns

      - name: dimension
        description: "The dimension used for identifying the optimal duration ('Company', 'Goal', 'Channel'). Populated only when analysis_type is 'optimal_durations'."
        data_type: VARCHAR
        tests:
          - accepted_values:
              values: ['Company', 'Goal', 'Channel']
              # This test passes if the value is NULL or one of the listed values.

      - name: category
        description: "The specific category within the dimension (e.g., company name, goal name, channel name). Populated only when analysis_type is 'optimal_durations'."
        data_type: VARCHAR

      - name: optimal_duration_bucket
        description: "The text representation of the campaign duration bucket (e.g., '22-30 days') identified as having the highest average ROI for the given company/dimension/category. Populated only when analysis_type is 'optimal_durations'."
        data_type: VARCHAR
        tests:
          - accepted_values:
              values: ['1-7 days', '8-14 days', '15-21 days', '22-30 days', '31-45 days', '46-60 days', '60+ days']
              # This test passes if the value is NULL or one of the listed values.

      - name: optimal_min_duration
        description: "The minimum campaign duration (in days) included in the optimal duration bucket. Populated only when analysis_type is 'optimal_durations'."
        data_type: BIGINT
        tests:
          - dbt_utils.accepted_range:
              min_value: 1
              # Allows NULLs

      - name: optimal_max_duration
        description: "The maximum campaign duration (in days) included in the optimal duration bucket. Populated only when analysis_type is 'optimal_durations'."
        data_type: BIGINT
        tests:
          - dbt_utils.accepted_range:
              min_value: 1
              # Allows NULLs

      - name: optimal_roi
        description: "The average Return on Investment (ROI) achieved within the optimal duration bucket for the given company/dimension/category. Populated only when analysis_type is 'optimal_durations'."
        data_type: DOUBLE
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              # Allows NULLs and potentially negative ROI, although typically positive. Setting min_value to 0 is a basic sanity check.

      - name: optimal_conversion_rate
        description: "The average conversion rate achieved within the optimal duration bucket for the given company/dimension/category. Populated only when analysis_type is 'optimal_durations'."
        data_type: DOUBLE
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1 # Conversion rate should be between 0 and 1
              # Allows NULLs

      - name: optimal_roi_per_day
        description: "The average Return on Investment (ROI) per day, calculated within the optimal duration bucket to normalize for duration length. Populated only when analysis_type is 'optimal_durations'."
        data_type: DOUBLE

      - name: optimal_duration_range
        description: "A formatted string representing the optimal duration range (e.g., '30-30 days', '31-45 days'). Derived from optimal_min_duration and optimal_max_duration. Populated only when analysis_type is 'optimal_durations'."
        data_type: VARCHAR

      - name: Duration
        description: "The exact duration of campaigns in days. Populated only when analysis_type is 'exact_duration_performance'."
        data_type: BIGINT
        tests:
          - dbt_utils.accepted_range:
              min_value: 1
              # Allows NULLs

      - name: campaign_count
        description: "The number of campaigns aggregated for this specific duration (when analysis_type is 'exact_duration_performance'). Based on HAVING clause, this should be >= 2."
        data_type: BIGINT
        tests:
          - dbt_utils.accepted_range:
              min_value: 2
              # Allows NULLs (for analysis_type = 'optimal_durations')

      - name: avg_conversion_rate
        description: "The average conversion rate for campaigns with the specified exact 'Duration'. Populated only when analysis_type is 'exact_duration_performance'."
        data_type: DOUBLE
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1 # Conversion rate should be between 0 and 1
              # Allows NULLs

      - name: avg_roi
        description: "The average Return on Investment (ROI) for campaigns with the specified exact 'Duration'. Populated only when analysis_type is 'exact_duration_performance'."
        data_type: DOUBLE
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              # Allows NULLs and potentially negative ROI. Setting min_value to 0 is a basic sanity check.

      - name: avg_acquisition_cost
        description: "The average acquisition cost for campaigns with the specified exact 'Duration'. Populated only when analysis_type is 'exact_duration_performance'."
        data_type: DOUBLE
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              # Allows NULLs

      - name: avg_ctr
        description: "The average Click-Through Rate (CTR) for campaigns with the specified exact 'Duration'. Populated only when analysis_type is 'exact_duration_performance'."
        data_type: FLOAT # Note: SQL calculates as FLOAT
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1 # CTR should be between 0 and 1
              # Allows NULLs

      - name: avg_roi_per_day
        description: "The average Return on Investment (ROI) per day for campaigns with the specified exact 'Duration'. Populated only when analysis_type is 'exact_duration_performance'."
        data_type: DOUBLE