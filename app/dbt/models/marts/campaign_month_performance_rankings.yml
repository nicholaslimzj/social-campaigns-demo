version: 2

models:
  - name: campaign_month_performance_rankings
    description: |
      Ranks campaigns for each company based on performance metrics over the last 30 days.
      Identifies top and bottom performers for ROI, conversion rate, revenue, and CPA.
      Calculates comparisons to company averages, assigns performance tiers based on ROI,
      and provides recommended optimization actions. Designed for campaign performance dashboards
      and analysis.
    config:
      materialized: table
      tags: ['mart', 'campaigns', 'performance', 'ranking', 'monthly']
    columns:
      - name: Company
        description: "The name of the company running the campaign."
        tests:
          - not_null
          - relationships:
              to: ref('stg_campaigns')
              field: Company

      - name: campaign_id
        description: "Unique identifier for the marketing campaign."
        tests:
          - not_null
          # Test for uniqueness within each company for this 30-day snapshot
          - dbt_utils.unique_combination_of_columns:
              combination_of_columns:
                - Company
                - campaign_id
          - relationships:
              to: ref('stg_campaigns')
              field: Campaign_ID # Assuming Campaign_ID is the corresponding field in stg_campaigns

      - name: goal
        description: "The primary objective of the campaign (e.g., Brand Awareness, Product Launch, Increase Sales)."
        tests:
          - not_null

      - name: channel
        description: "The marketing channel used for the campaign (e.g., Instagram, Twitter, Facebook)."
        tests:
          - not_null

      - name: segment
        description: "The target customer segment for the campaign (e.g., Fashion, Technology)."
        tests:
          - not_null

      - name: roi
        description: "Return on Investment for the campaign over the last 30 days (Revenue / Spend)."
        data_type: DOUBLE
        tests:
          - not_null
          # ROI can be negative if spend > revenue
          # - dbt_utils.accepted_range:
          #     min_value: 0 # Allow 0 ROI, potentially negative if spend > revenue

      - name: conversion_rate
        description: "Average conversion rate for the campaign over the last 30 days."
        data_type: DOUBLE
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1 # Conversion rate should be between 0 and 1

      - name: spend
        description: "Total amount spent (Acquisition Cost) on the campaign over the last 30 days."
        data_type: DOUBLE
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: revenue
        description: "Total revenue generated by the campaign over the last 30 days (Spend * ROI)."
        data_type: DOUBLE
        tests:
          - not_null
          # Revenue can theoretically be 0
          - dbt_utils.accepted_range:
              min_value: 0

      - name: acquisition_cost
        description: "Average acquisition cost per campaign instance over the last 30 days (used as basis for CPA calculation)."
        data_type: DOUBLE
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: cpa
        description: "Cost Per Acquisition for the campaign over the last 30 days (Spend / Conversions). Falls back to average acquisition cost if no conversions."
        data_type: DOUBLE
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: ctr
        description: "Click-Through Rate for the campaign over the last 30 days (Clicks / Impressions)."
        data_type: FLOAT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              # CTR could theoretically exceed 1 in rare cases (multiple clicks per impression), but usually <= 1
              # max_value: 1

      - name: clicks
        description: "Total number of clicks for the campaign over the last 30 days."
        data_type: HUGEINT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0

      - name: impressions
        description: "Total number of impressions for the campaign over the last 30 days. Filtered for > 1000 impressions."
        data_type: HUGEINT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1001 # Based on the HAVING clause SUM(Impressions) > 1000

      - name: start_date
        description: "The earliest date included in this 30-day performance window for the campaign."
        data_type: TIMESTAMP_NS
        tests:
          - not_null

      - name: end_date
        description: "The latest date included in this 30-day performance window for the campaign."
        data_type: TIMESTAMP_NS
        tests:
          - not_null

      - name: duration_days
        description: "The number of days covered within the 30-day window for which this campaign had data."
        data_type: BIGINT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1 # Must have at least one day of data
              max_value: 31 # Maximum duration within a 30-day rolling window

      - name: roi_vs_company_avg
        description: "Campaign ROI compared to the average ROI for all campaigns within the same company (Campaign ROI / Company Avg ROI)."
        data_type: DOUBLE
        # This can be null if company avg ROI is 0

      - name: conversion_vs_company_avg
        description: "Campaign conversion rate compared to the average conversion rate for all campaigns within the same company."
        data_type: DOUBLE
        # This can be null if company avg conversion rate is 0

      - name: acquisition_efficiency
        description: "Measure of how cost-efficient the campaign's acquisition cost is compared to the company average (Company Avg Acquisition Cost / Campaign Acquisition Cost)."
        data_type: DOUBLE
        # This can be null if campaign acquisition cost is 0

      - name: revenue_share
        description: "The campaign's contribution to the total company revenue over the last 30 days."
        data_type: DOUBLE
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              # max_value: 1 # Can be slightly > 0 if only one campaign

      - name: spend_share
        description: "The campaign's share of the total company spend over the last 30 days."
        data_type: DOUBLE
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              # max_value: 1 # Can be slightly > 0 if only one campaign

      - name: roi_rank
        description: "Rank of the campaign within its company based on ROI (descending - 1 is best)."
        data_type: BIGINT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: conversion_rank
        description: "Rank of the campaign within its company based on conversion rate (descending - 1 is best)."
        data_type: BIGINT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: revenue_rank
        description: "Rank of the campaign within its company based on revenue generated (descending - 1 is best)."
        data_type: BIGINT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: cpa_rank
        description: "Rank of the campaign within its company based on CPA (ascending - 1 is best/lowest)."
        data_type: BIGINT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: roi_rank_asc
        description: "Rank of the campaign within its company based on ROI (ascending - 1 is worst)."
        data_type: BIGINT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: conversion_rank_asc
        description: "Rank of the campaign within its company based on conversion rate (ascending - 1 is worst)."
        data_type: BIGINT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: revenue_rank_asc
        description: "Rank of the campaign within its company based on revenue generated (ascending - 1 is worst)."
        data_type: BIGINT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: cpa_rank_asc
        description: "Rank of the campaign within its company based on CPA (descending - 1 is worst/highest)."
        data_type: BIGINT
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1

      - name: performance_tier
        description: "Performance category assigned based on ROI (excellent, good, average, below_average)."
        data_type: VARCHAR
        tests:
          - not_null
          - accepted_values:
              values: ['excellent', 'good', 'average', 'below_average']

      - name: recommended_action
        description: "Suggested optimization action based on campaign performance metrics relative to company averages."
        data_type: VARCHAR
        tests:
          - not_null
          - accepted_values:
              values: ['Increase budget allocation', 'Reduce budget allocation', 'Optimize for conversions', 'Improve cost efficiency', 'Maintain current strategy']

      - name: is_top_roi_performer
        description: "Flag indicating if the campaign is among the top ROI performers (Top 5 or Top 10%)."
        data_type: BOOLEAN
        tests:
          - not_null

      - name: is_top_conversion_performer
        description: "Flag indicating if the campaign is among the top conversion rate performers (Top 5 or Top 10%)."
        data_type: BOOLEAN
        tests:
          - not_null

      - name: is_top_revenue_performer
        description: "Flag indicating if the campaign is among the top revenue performers (Top 5 or Top 10%)."
        data_type: BOOLEAN
        tests:
          - not_null

      - name: is_top_cpa_performer
        description: "Flag indicating if the campaign is among the top CPA performers (lowest CPA - Top 5 or Top 10%)."
        data_type: BOOLEAN
        tests:
          - not_null

      - name: is_bottom_roi_performer
        description: "Flag indicating if the campaign is among the bottom ROI performers (Bottom 5 or Bottom 10%)."
        data_type: BOOLEAN
        tests:
          - not_null

      - name: is_bottom_conversion_performer
        description: "Flag indicating if the campaign is among the bottom conversion rate performers (Bottom 5 or Bottom 10%)."
        data_type: BOOLEAN
        tests:
          - not_null

      - name: is_bottom_revenue_performer
        description: "Flag indicating if the campaign is among the bottom revenue performers (Bottom 5 or Bottom 10%)."
        data_type: BOOLEAN
        tests:
          - not_null

      - name: is_bottom_cpa_performer
        description: "Flag indicating if the campaign is among the bottom CPA performers (highest CPA - Bottom 5 or Bottom 10%)."
        data_type: BOOLEAN
        tests:
          - not_null