{
  "name": "anomaly_flags",
  "description": "This mart model calculates key marketing metrics (Conversion Rate, ROI, Acquisition Cost, Clicks, Impressions, CTR) aggregated monthly per company from the `stg_campaigns` model. It then computes rolling 3-month averages and standard deviations for these metrics (excluding the current month) to establish a baseline. Finally, it calculates z-scores for each metric in the current month against its rolling baseline and flags months where any metric deviates significantly (absolute z-score > 2) as an anomaly. This helps identify unusual performance periods for further investigation.\n",
  "columns": [
    {
      "name": "Company",
      "type": "VARCHAR",
      "description": "The unique identifier or name of the company.",
      "tests": [
        "not_null",
        "relationships",
        "dbt_utils.unique_combination_of_columns"
      ],
      "tags": []
    },
    {
      "name": "month",
      "type": "BIGINT",
      "description": "The calendar month (1-12) for which the metrics are aggregated.",
      "tests": [
        "not_null",
        "accepted_values"
      ],
      "tags": []
    },
    {
      "name": "avg_conversion_rate",
      "type": "DOUBLE",
      "description": "The average conversion rate for the company during the specified month.",
      "tests": [
        "not_null"
      ],
      "tags": []
    },
    {
      "name": "conversion_rate_mean",
      "type": "DOUBLE",
      "description": "The rolling 3-month average conversion rate, excluding the current month. Used as the baseline mean for anomaly detection.",
      "tests": [],
      "tags": []
    },
    {
      "name": "conversion_rate_std",
      "type": "DOUBLE",
      "description": "The rolling 3-month population standard deviation of the conversion rate, excluding the current month. Used as the baseline std dev for anomaly detection.",
      "tests": [],
      "tags": []
    },
    {
      "name": "conversion_rate_z",
      "type": "DOUBLE",
      "description": "The z-score for the month's average conversion rate, calculated as (avg_conversion_rate - conversion_rate_mean) / conversion_rate_std. Measures deviation from the rolling baseline.",
      "tests": [],
      "tags": []
    },
    {
      "name": "conversion_rate_anomaly",
      "type": "VARCHAR",
      "description": "Flag indicating if the conversion rate for the month is considered an anomaly ('anomaly') or within the expected range ('normal') based on an absolute z-score threshold of 2.",
      "tests": [
        "not_null",
        "accepted_values"
      ],
      "tags": []
    },
    {
      "name": "avg_roi",
      "type": "DOUBLE",
      "description": "The average Return on Investment (ROI) for the company during the specified month.",
      "tests": [
        "not_null"
      ],
      "tags": []
    },
    {
      "name": "roi_mean",
      "type": "DOUBLE",
      "description": "The rolling 3-month average ROI, excluding the current month. Used as the baseline mean for anomaly detection.",
      "tests": [],
      "tags": []
    },
    {
      "name": "roi_std",
      "type": "DOUBLE",
      "description": "The rolling 3-month population standard deviation of ROI, excluding the current month. Used as the baseline std dev for anomaly detection.",
      "tests": [],
      "tags": []
    },
    {
      "name": "roi_z",
      "type": "DOUBLE",
      "description": "The z-score for the month's average ROI, calculated as (avg_roi - roi_mean) / roi_std. Measures deviation from the rolling baseline.",
      "tests": [],
      "tags": []
    },
    {
      "name": "roi_anomaly",
      "type": "VARCHAR",
      "description": "Flag indicating if the ROI for the month is considered an anomaly ('anomaly') or within the expected range ('normal') based on an absolute z-score threshold of 2.",
      "tests": [
        "not_null",
        "accepted_values"
      ],
      "tags": []
    },
    {
      "name": "avg_acquisition_cost",
      "type": "DOUBLE",
      "description": "The average acquisition cost for the company during the specified month.",
      "tests": [
        "not_null"
      ],
      "tags": []
    },
    {
      "name": "acquisition_cost_mean",
      "type": "DOUBLE",
      "description": "The rolling 3-month average acquisition cost, excluding the current month. Used as the baseline mean for anomaly detection.",
      "tests": [],
      "tags": []
    },
    {
      "name": "acquisition_cost_std",
      "type": "DOUBLE",
      "description": "The rolling 3-month population standard deviation of acquisition cost, excluding the current month. Used as the baseline std dev for anomaly detection.",
      "tests": [],
      "tags": []
    },
    {
      "name": "acquisition_cost_z",
      "type": "DOUBLE",
      "description": "The z-score for the month's average acquisition cost, calculated as (avg_acquisition_cost - acquisition_cost_mean) / acquisition_cost_std. Measures deviation from the rolling baseline.",
      "tests": [],
      "tags": []
    },
    {
      "name": "acquisition_cost_anomaly",
      "type": "VARCHAR",
      "description": "Flag indicating if the acquisition cost for the month is considered an anomaly ('anomaly') or within the expected range ('normal') based on an absolute z-score threshold of 2.",
      "tests": [
        "not_null",
        "accepted_values"
      ],
      "tags": []
    },
    {
      "name": "total_clicks",
      "type": "HUGEINT",
      "description": "The total number of clicks for the company during the specified month.",
      "tests": [
        "not_null"
      ],
      "tags": []
    },
    {
      "name": "clicks_mean",
      "type": "DOUBLE",
      "description": "The rolling 3-month average total clicks, excluding the current month. Used as the baseline mean for anomaly detection.",
      "tests": [],
      "tags": []
    },
    {
      "name": "clicks_std",
      "type": "DOUBLE",
      "description": "The rolling 3-month population standard deviation of total clicks, excluding the current month. Used as the baseline std dev for anomaly detection.",
      "tests": [],
      "tags": []
    },
    {
      "name": "clicks_z",
      "type": "DOUBLE",
      "description": "The z-score for the month's total clicks, calculated as (total_clicks - clicks_mean) / clicks_std. Measures deviation from the rolling baseline.",
      "tests": [],
      "tags": []
    },
    {
      "name": "clicks_anomaly",
      "type": "VARCHAR",
      "description": "Flag indicating if the total clicks for the month is considered an anomaly ('anomaly') or within the expected range ('normal') based on an absolute z-score threshold of 2.",
      "tests": [
        "not_null",
        "accepted_values"
      ],
      "tags": []
    },
    {
      "name": "total_impressions",
      "type": "HUGEINT",
      "description": "The total number of impressions for the company during the specified month.",
      "tests": [
        "not_null"
      ],
      "tags": []
    },
    {
      "name": "impressions_mean",
      "type": "DOUBLE",
      "description": "The rolling 3-month average total impressions, excluding the current month. Used as the baseline mean for anomaly detection.",
      "tests": [],
      "tags": []
    },
    {
      "name": "impressions_std",
      "type": "DOUBLE",
      "description": "The rolling 3-month population standard deviation of total impressions, excluding the current month. Used as the baseline std dev for anomaly detection.",
      "tests": [],
      "tags": []
    },
    {
      "name": "impressions_z",
      "type": "DOUBLE",
      "description": "The z-score for the month's total impressions, calculated as (total_impressions - impressions_mean) / impressions_std. Measures deviation from the rolling baseline.",
      "tests": [],
      "tags": []
    },
    {
      "name": "impressions_anomaly",
      "type": "VARCHAR",
      "description": "Flag indicating if the total impressions for the month is considered an anomaly ('anomaly') or within the expected range ('normal') based on an absolute z-score threshold of 2.",
      "tests": [
        "not_null",
        "accepted_values"
      ],
      "tags": []
    },
    {
      "name": "monthly_ctr",
      "type": "FLOAT",
      "description": "The calculated Click-Through Rate (CTR) for the company during the specified month (Total Clicks / Total Impressions).",
      "tests": [
        "not_null"
      ],
      "tags": []
    },
    {
      "name": "ctr_mean",
      "type": "DOUBLE",
      "description": "The rolling 3-month average CTR, excluding the current month. Used as the baseline mean for anomaly detection.",
      "tests": [],
      "tags": []
    },
    {
      "name": "ctr_std",
      "type": "DOUBLE",
      "description": "The rolling 3-month population standard deviation of CTR, excluding the current month. Used as the baseline std dev for anomaly detection.",
      "tests": [],
      "tags": []
    },
    {
      "name": "ctr_z",
      "type": "DOUBLE",
      "description": "The z-score for the month's CTR, calculated as (monthly_ctr - ctr_mean) / ctr_std. Measures deviation from the rolling baseline.",
      "tests": [],
      "tags": []
    },
    {
      "name": "ctr_anomaly",
      "type": "VARCHAR",
      "description": "Flag indicating if the CTR for the month is considered an anomaly ('anomaly') or within the expected range ('normal') based on an absolute z-score threshold of 2.",
      "tests": [
        "not_null",
        "accepted_values"
      ],
      "tags": []
    },
    {
      "name": "has_anomaly",
      "type": "BOOLEAN",
      "description": "A boolean summary flag indicating TRUE if any of the individual metric anomaly flags ('conversion_rate_anomaly', 'roi_anomaly', etc.) is set to 'anomaly' for that company and month, FALSE otherwise. Useful for quick filtering.",
      "tests": [
        "not_null"
      ],
      "tags": []
    }
  ],
  "tags": []
}